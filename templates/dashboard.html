{% extends 'base.html' %}

{% block body_class %}dashboard-page{% endblock %}

{% block content %}

<div class="container">
  <h1>Dashboard</h1>

  <div class="button-row" style="display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; gap: 10px; align-items: center;">
      <button class="btn btn-outline-green" onclick="toggleSessionForm()">New Session</button>
      <a href="{{ url_for('view_logs') }}" class="btn">View Logs</a>
      <a href="{{ url_for('view_banking') }}" class="btn">Banking</a>
      <a href="{{ url_for('view_comps') }}" class="btn">Comps</a>
      <a href="{{ url_for('view_locations') }}" class="btn">Locations</a>
    </div>
    <div style="display: flex; gap: 10px; align-items: center;">
      <a href="{{ url_for('donate') }}" class="btn" style="margin-right: 0;">Support Development</a>
      <button class="btn" onclick="openFeedbackModal()">Give Feedback</button>
      <button class="btn" onclick="openSettingsModal()">Settings</button>
      <a href="{{ url_for('logout')}}" class="btn btn-outline-red">Logout</a>
    </div>
  </div>

  <!-- Collapsible session form -->
  <div id="sessionForm" class="session-form hidden" style="margin-left:-0.60rem;">
    <form method="POST" action="/add_session">
      <div class="form-grid">
        <div class="input-lock-container">
          <input type="date" name="date" id="dateInput" required>
        </div>
        <div class="input-lock-container">
          <input type="text" name="location" id="locationInput" placeholder="Location">
          <button type="button" class="lock-btn" data-target="locationInput">ðŸ”’</button>
        </div>
        <div class="input-lock-container">
          <select name="type" id="typeInput" required>
            <option value="">Type</option>
            {% for type in unique_types %}
              <option value="{{ type }}">{{ type }}</option>
            {% endfor %}
          </select>
          <button type="button" class="lock-btn" data-target="typeInput">ðŸ”’</button>
        </div>
        <!-- Stakes input removed as it is now poker-specific -->

        <input type="time" name="time_in" placeholder="Time In">
        <input type="time" name="time_out" placeholder="Time Out">
        <input type="number" name="money_in" placeholder="Money In" step="0.01">
        <input type="number" name="money_out" placeholder="Money Out" step="0.01">

        <div class="input-lock-container">
          <input type="number" name="comps_in" id="compsInInput" placeholder="Comps In" step="0.01">
          <button type="button" class="lock-btn" data-target="compsInInput">ðŸ”’</button>
        </div>
        <div class="input-lock-container">
          <input type="number" name="comps_out" id="compsOutInput" placeholder="Comps Out" step="0.01">
          <button type="button" class="lock-btn" data-target="compsOutInput">ðŸ”’</button>
        </div>

        <input type="number" name="tips" placeholder="Tips" step="0.01">
      </div>
      <button type="submit" class="btn">Submit</button>
    </form>
  </div>

  <!-- Sidebar + All Charts (Top & Bottom) -->
  <div class="main-content" style="display: flex; align-items: flex-start; gap: 2.5rem;">
    <!-- Sidebar Column: vertical flex for stacking -->
    <div class="sidebar-scroll" style="display: flex; flex-direction: column; align-items: stretch; gap: 0; height: calc(100vh - 70px); overflow-y: scroll; min-height: 0;">
      <div class="sidebar" style="width: 200px; background-color: #111; padding: 1rem; border-radius: 10px; font-size: 0.92em; height: auto; min-height: 0;">
        <h3 style="color: #ffffff; font-family: Consolas, monospace;">Ventures</h3>
        <ul style="list-style: none; padding-left: 0;">
          {% for type in unique_types %}
            <li style="color: #aaa; padding: 0.25rem 0; border-bottom: 1px solid #222;">
              {% if type == 'Blackjack' %}
                <a href="{{ url_for('view_blackjack') }}" style="color: #00ffff; text-decoration: none; font-weight: bold;">Blackjack</a>
              {% elif type == 'Poker' %}
                <a href="{{ url_for('view_poker') }}" style="color: #ff66cc; text-decoration: none; font-weight: bold;">Poker</a>
              {% elif type == 'Match Play' %}
                <a href="{{ url_for('view_matchplay') }}" style="color: #ffaa00; text-decoration: none; font-weight: bold;">Match Play</a>
              {% else %}
                {{ type }}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
        <div id="add-venture-section" style="margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid #333;">
          <div class="dropdown-container" style="position: relative;">
            <button id="add-venture-btn" class="btn btn-outline-green" style="width: 100%; font-size: 0.85em; padding: 0.3rem;" onclick="toggleVentureDropdown()">Add Venture</button>
            <div id="venture-dropdown" class="venture-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #1a1a1a; border: 1px solid #333; border-radius: 6px; z-index: 1000; margin-top: 2px;">
              <div class="venture-option" data-venture="Blackjack" onclick="addVenture('Blackjack')">
                <span style="color: #00ffff;">Blackjack</span>
              </div>
              <div class="venture-option" data-venture="Poker" onclick="addVenture('Poker')">
                <span style="color: #ff66cc;">Poker</span>
              </div>
              <div class="venture-option" data-venture="Match Play" onclick="addVenture('Match Play')">
                <span style="color: #ffaa00;">Match Play</span>
              </div>
              <div class="venture-option disabled" data-venture="Day Trading">
                <span style="color: #666;">Day Trading</span>
                <span style="color: #666; font-size: 0.8em; margin-left: 0.5rem;">(Coming Soon)</span>
              </div>
              <div class="venture-option disabled" data-venture="Sports Betting">
                <span style="color: #666;">Sports Betting</span>
                <span style="color: #666; font-size: 0.8em; margin-left: 0.5rem;">(Coming Soon)</span>
              </div>
              <div class="venture-option disabled" data-venture="Tournament">
                <span style="color: #666;">Tournament</span>
                <span style="color: #666; font-size: 0.8em; margin-left: 0.5rem;">(Coming Soon)</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="sidebar" style="width: 200px; background-color: #111; padding: 1rem; border-radius: 10px; margin-top: 1.5rem; font-size: 0.90em; height: auto; min-height: 0;">
        <h3 style="color: #ffffff; font-family: Consolas, monospace;">All Time Statistics</h3>
        <ul style="list-style: none; padding-left: 0; color: #ccc; font-family: 'JetBrains Mono', monospace; font-size: 0.90em;">
          <li style="margin-bottom: 0.3em;">Total Hours Played: <span style="color:#00ccff; float:right;">{{ all_time_stats.total_hours }}</span></li>
          <li style="margin-bottom: 0.3em;">Total Profit: <span style="color:{% if all_time_stats.total_profit >= 0 %}#00ff99{% else %}#ff4444{% endif %}; float:right;">${{ all_time_stats.total_profit }}</span></li>
          <li style="margin-bottom: 0.3em;">Hourly Rate: <span style="color:{% if all_time_stats.hourly_rate >= 0 %}#00ff99{% else %}#ff4444{% endif %}; float:right;">${{ all_time_stats.hourly_rate }}</span></li>
          <li style="margin-bottom: 0.3em;">Best Session: <span style="color:#00ff99; float:right;">${{ all_time_stats.best_session }}</span></li>
          <li style="margin-bottom: 0.3em;">Worst Session: <span style="color:#ff4444; float:right;">${{ all_time_stats.worst_session }}</span></li>
          <li style="margin-bottom: 0.3em;">Comps Realized: <span style="color:#ffaa00; float:right;">${{ all_time_stats.comps_realized }}</span></li>
        </ul>
        <div style="margin-top: 1.2em; display: flex; flex-direction: column; align-items: center; justify-content: center;">
          <div style="color: #ccc; font-size: 0.97em; text-align: center; margin-bottom: 0.5em;">Include Tips in PnL</div>
          <label class="custom-slider-switch">
            <input type="checkbox" id="tips-toggle" {% if tips_included %}checked{% endif %}>
            <span class="custom-slider"></span>
          </label>
        </div>
      </div>
      <!-- Personal Bests Panel -->
      <div class="sidebar" style="width: 200px; background-color: #111; padding: 1rem; border-radius: 10px; margin-top: 1.2rem; font-size: 0.89em; height: auto; min-height: 0;">
        <h3 style="color: #ffffff; font-family: Consolas, monospace;">Personal Bests</h3>
        <ul style="list-style: none; padding-left: 0; color: #ccc; font-family: 'JetBrains Mono', monospace; font-size: 0.89em;">
          <li style="margin-bottom: 0.3em;">Longest Winning Streak: <span style="color:#00ff99; float:right;">{{ personal_bests.longest_streak }}</span></li>
          <li style="margin-bottom: 0.3em;">Most Profitable Day: <span style="color:#00ff99; float:right;">${{ personal_bests.most_profitable_day[1] }}</span></li>
          <li style="margin-bottom: 0.3em;">Longest Session: <span style="color:#00ccff; float:right;">{{ personal_bests.longest_session }}h</span></li>
        </ul>
      </div>
      <!-- Reminders Panel -->
      <div class="sidebar" style="width: 200px; background-color: #111; padding: 1rem; border-radius: 10px; margin-top: 1.2rem; font-size: 0.89em; position: relative; min-height: 130px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">
          <h3 style="color: #ffffff; font-family: Consolas, monospace; margin: 0;">Reminders</h3>
          <button class="btn btn-outline-green" style="font-size: 0.85em; padding: 2px 8px; height: 1.7em; line-height: 1; margin-left: 0.5em;">Add Reminder</button>
        </div>
        <div style="color: #ffaa00; font-size: 1.1em; text-align: center; margin-top: 1em;">Coming soon!</div>
      </div>
    </div>
    <style>
    /* Custom scrollbar for sidebar - matches site style */
    .main-content > div[style*='flex-direction: column'] {
      scrollbar-width: thin;
      scrollbar-color: #444 #222;
    }
    .main-content > div[style*='flex-direction: column']::-webkit-scrollbar {
      width: 10px;
      background: #222;
      border-radius: 8px;
    }
    .main-content > div[style*='flex-direction: column']::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 8px;
      min-height: 40px;
    }
    .main-content > div[style*='flex-direction: column']::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    </style>
    
    <!-- Venture Dropdown Styles -->
    <style>
    .venture-dropdown {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    
    .venture-option {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid #333;
      transition: background-color 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .venture-option:last-child {
      border-bottom: none;
    }
    
    .venture-option:hover:not(.disabled) {
      background-color: #333;
    }
    
    .venture-option.disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .venture-option.disabled:hover {
      background-color: transparent;
    }
    
    /* Session form select styling */
    .input-lock-container select {
      width: 100%;
      padding: 0.5rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      color: #fff;
      font-size: 0.9em;
      outline: none;
      transition: border-color 0.2s ease;
      /* Remove dropdown arrow */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      /* Use same font as other inputs */
      font-family: inherit;
    }
    
    .input-lock-container select:focus {
      border-color: #00ff99;
    }
    
    .input-lock-container select option {
      background: #1a1a1a;
      color: #fff;
      padding: 0.5rem;
      font-family: inherit;
    }
    
    .input-lock-container select option:hover {
      background: #333;
    }
    
    /* Venture management styles */
    .venture-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      transition: all 0.2s ease;
    }
    
    .venture-item:hover {
      border-color: #444;
      background: #222;
    }
    
    .venture-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .venture-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .venture-name {
      color: #fff;
      font-weight: 500;
    }
    
    .delete-venture-btn {
      background: #ff4444;
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
      transition: background-color 0.2s ease;
    }
    
    .delete-venture-btn:hover {
      background: #cc3333;
    }
    
    .no-ventures {
      color: #666;
      font-style: italic;
      text-align: center;
      padding: 1rem;
    }
    </style>
    
    <!-- Dashboard Charts -->
    <div class="dashboard-grid" style="flex: 1;">
      <!-- Top Row -->
      <div class="chart chart-wide">
        <div class="chart-label green">Cumulative Profit (PnL)</div>
        <canvas id="profitChart"></canvas>
      </div>
      <div class="chart chart-wide">
        <div class="chart-label blue">Total Bankroll by Date</div>
        <canvas id="combinedBankrollChart"></canvas>
      </div>
      <!-- Bottom Row: Venture Charts (each appended as a .chart.chart-narrow) -->
      <div id="ventureCharts" class="venture-grid"></div>
    </div>
  </div>

</div> <!-- End of .container or main content -->

<!-- Feedback Modal -->
<div id="feedbackModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 600px; width: 90%;">
    <h3 style="color: #fff; margin-bottom: 1.5rem; text-align: center;">Submit Feedback</h3>
    
    <form id="feedbackForm" onsubmit="submitFeedback(event)">
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">Feedback Type:</label>
        <select id="feedbackType" name="feedback_type" class="styled-select" required>
          <option value="">Select type...</option>
          <option value="Bug Report">Bug Report</option>
          <option value="Feature Request">Feature Request</option>
        </select>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">Significance (1-5):</label>
        <select id="significance" name="significance" class="styled-select" required>
          <option value="">Select significance...</option>
          <option value="1">1 - Minor</option>
          <option value="2">2 - Low</option>
          <option value="3">3 - Medium</option>
          <option value="4">4 - High</option>
          <option value="5">5 - Critical</option>
        </select>
        <div id="significanceGuide" style="color: #666; font-size: 0.9em; margin-top: 0.5rem;"></div>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">Subject:</label>
        <input type="text" id="subject" name="subject" class="styled-input" placeholder="Brief description of your feedback" required>
      </div>

      <div style="margin-bottom: 2rem;">
        <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">Message:</label>
        <textarea id="message" name="message" class="styled-input" rows="6" placeholder="Please provide detailed feedback..." required></textarea>
      </div>

      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button type="button" class="btn" style="background: #1a1a1a;" onclick="closeFeedbackModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-outline-green">
          Submit Feedback
        </button>
      </div>
    </form>
  </div>
</div>

<!-- QUOTE CONTAINER: Centered between charts and ticker, not under sidebar -->
<div id="quote-container" style="position: absolute; left: 300px; right: 40px; margin: 0 auto; bottom: 3.8em; width: auto; max-width: none; min-width: 300px; z-index: 900; text-align: center;">
  <div id="quote-box" style="background: #181818; color: #fff; border-radius: 10px; border: 1px solid #333; width: 100%; height: 4em; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; justify-content: center; font-size: 1em; font-family: 'JetBrains Mono', Consolas, monospace; box-shadow: 0 2px 12px #000a;">
    <!-- Quote will be inserted here -->
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 500px; width: 90%;">
    <h3 style="color: #fff; margin-bottom: 1.5rem; text-align: center;">Settings</h3>
    
    <div style="margin-bottom: 2rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <label style="color: #ccc; font-size: 1rem;">Show Add Venture Button:</label>
        <label class="custom-slider-switch">
          <input type="checkbox" id="show-venture-btn-toggle" checked>
          <span class="custom-slider"></span>
        </label>
      </div>
      <div style="color: #666; font-size: 0.9em;">
        When enabled, the "Add Venture" button will be visible in the Ventures sidebar.
      </div>
    </div>

    <!-- Venture Management Section -->
    <div style="margin-bottom: 2rem;">
      <h4 style="color: #fff; margin-bottom: 1rem; font-size: 1.1rem;">Manage Ventures</h4>
      <div id="venture-management-list" style="max-height: 200px; overflow-y: auto;">
        <!-- Ventures will be loaded here dynamically -->
      </div>
      <div style="color: #666; font-size: 0.9em; margin-top: 0.5rem;">
        Remove ventures you no longer need. This won't delete your session data.
      </div>
    </div>

    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button type="button" class="btn" style="background: #1a1a1a;" onclick="closeSettingsModal()">
        Cancel
      </button>
      <button type="button" class="btn btn-outline-green" onclick="saveSettings()">
        Save Settings
      </button>
    </div>
  </div>
</div>

<script>
// Settings modal functionality - defined immediately after the modal HTML
function openSettingsModal() {
  console.log('openSettingsModal called');
  const modal = document.getElementById('settingsModal');
  if (!modal) {
    console.error('Settings modal not found!');
    return;
  }
  modal.style.display = 'flex';
  // Load current settings
  const showVentureBtn = localStorage.getItem('showVentureBtn') !== 'false'; // Default to true
  const toggle = document.getElementById('show-venture-btn-toggle');
  if (toggle) {
    toggle.checked = showVentureBtn;
  }
  updateVentureButtonVisibility(showVentureBtn);
  
  // Load ventures for management
  loadVenturesForManagement();
}

function closeSettingsModal() {
  console.log('closeSettingsModal called');
  const modal = document.getElementById('settingsModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

function saveSettings() {
  const showVentureBtn = document.getElementById('show-venture-btn-toggle').checked;
  localStorage.setItem('showVentureBtn', showVentureBtn);
  updateVentureButtonVisibility(showVentureBtn);
  closeSettingsModal();
}

function updateVentureButtonVisibility(show) {
  const addVentureSection = document.getElementById('add-venture-section');
  if (addVentureSection) {
    addVentureSection.style.display = show ? 'block' : 'none';
  }
}

// Venture dropdown functionality
function toggleVentureDropdown() {
  const dropdown = document.getElementById('venture-dropdown');
  if (dropdown) {
    const isVisible = dropdown.style.display !== 'none';
    if (!isVisible) {
      // Show dropdown and filter out existing ventures
      filterVentureOptions();
    }
    dropdown.style.display = isVisible ? 'none' : 'block';
  }
}

function filterVentureOptions() {
  // Get current active ventures from the sidebar
  const ventureList = document.querySelector('.sidebar ul');
  const existingVentures = [];
  
  if (ventureList) {
    const ventureItems = ventureList.querySelectorAll('li');
    ventureItems.forEach(item => {
      const ventureText = item.textContent.trim();
      if (ventureText && ventureText !== '') {
        existingVentures.push(ventureText);
      }
    });
  }
  
  // Hide options for ventures that already exist
  const ventureOptions = document.querySelectorAll('.venture-option');
  ventureOptions.forEach(option => {
    const ventureType = option.getAttribute('data-venture');
    if (existingVentures.includes(ventureType)) {
      option.style.display = 'none';
    } else {
      option.style.display = 'flex';
    }
  });
  
  // If no options are available, show a message
  const visibleOptions = Array.from(ventureOptions).filter(option => 
    option.style.display !== 'none' && !option.classList.contains('disabled')
  );
  
  if (visibleOptions.length === 0) {
    // Add a "no more ventures" message if it doesn't exist
    let noMoreMessage = document.getElementById('no-more-ventures');
    if (!noMoreMessage) {
      noMoreMessage = document.createElement('div');
      noMoreMessage.id = 'no-more-ventures';
      noMoreMessage.style.padding = '0.5rem 0.75rem';
      noMoreMessage.style.color = '#666';
      noMoreMessage.style.fontStyle = 'italic';
      noMoreMessage.style.textAlign = 'center';
      noMoreMessage.textContent = 'All available ventures added!';
      dropdown.appendChild(noMoreMessage);
    }
    noMoreMessage.style.display = 'block';
  } else {
    // Hide the message if there are available options
    const noMoreMessage = document.getElementById('no-more-ventures');
    if (noMoreMessage) {
      noMoreMessage.style.display = 'none';
    }
  }
}

async function addVenture(ventureType) {
  try {
    // Send API request to add venture
    const response = await fetch('/api/user_ventures', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ venture_type: ventureType })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Add the venture to the sidebar
      const ventureList = document.querySelector('.sidebar ul');
      if (ventureList) {
        const newVentureItem = document.createElement('li');
        newVentureItem.style.color = '#aaa';
        newVentureItem.style.padding = '0.25rem 0';
        newVentureItem.style.borderBottom = '1px solid #222';
        
        // Create the venture link based on type
        let ventureLink;
        if (ventureType === 'Blackjack') {
          ventureLink = document.createElement('a');
          ventureLink.href = '/blackjack';
          ventureLink.style.color = '#00ffff';
          ventureLink.style.textDecoration = 'none';
          ventureLink.style.fontWeight = 'bold';
          ventureLink.textContent = 'Blackjack';
        } else if (ventureType === 'Poker') {
          ventureLink = document.createElement('a');
          ventureLink.href = '/poker';
          ventureLink.style.color = '#ff66cc';
          ventureLink.style.textDecoration = 'none';
          ventureLink.style.fontWeight = 'bold';
          ventureLink.textContent = 'Poker';
        } else if (ventureType === 'Match Play') {
          ventureLink = document.createElement('a');
          ventureLink.href = '/matchplay';
          ventureLink.style.color = '#ffaa00';
          ventureLink.style.textDecoration = 'none';
          ventureLink.style.fontWeight = 'bold';
          ventureLink.textContent = 'Match Play';
        } else {
          // For other venture types, just show as text
          ventureLink = document.createTextNode(ventureType);
        }
        
        newVentureItem.appendChild(ventureLink);
        ventureList.appendChild(newVentureItem);
      }
      
      // Update the session form type dropdown
      updateSessionFormTypeDropdown();
      
      // Close the dropdown
      toggleVentureDropdown();
      
      // Show success message
      alert(`${ventureType} venture added successfully!`);
    } else {
      alert(`Error adding venture: ${result.error}`);
    }
  } catch (error) {
    console.error('Error adding venture:', error);
    alert('Error adding venture. Please try again.');
  }
}

function updateSessionFormTypeDropdown() {
  const typeSelect = document.getElementById('typeInput');
  if (!typeSelect) return;
  
  // Get current ventures from sidebar
  const ventureList = document.querySelector('.sidebar ul');
  const currentVentures = [];
  
  if (ventureList) {
    const ventureItems = ventureList.querySelectorAll('li');
    ventureItems.forEach(item => {
      const ventureText = item.textContent.trim();
      if (ventureText && ventureText !== '') {
        currentVentures.push(ventureText);
      }
    });
  }
  
  // Clear existing options except the first placeholder
  typeSelect.innerHTML = '<option value="">Type</option>';
  
  // Add options for current ventures
  currentVentures.forEach(venture => {
    const option = document.createElement('option');
    option.value = venture;
    option.textContent = venture;
    typeSelect.appendChild(option);
  });
  
  // Auto-select if only one venture available
  if (currentVentures.length === 1) {
    typeSelect.value = currentVentures[0];
  }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('venture-dropdown');
  const addVentureBtn = document.getElementById('add-venture-btn');
  
  if (dropdown && addVentureBtn) {
    if (!dropdown.contains(event.target) && !addVentureBtn.contains(event.target)) {
      dropdown.style.display = 'none';
    }
  }
});

// Initialize settings on page load
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing settings');
  const showVentureBtn = localStorage.getItem('showVentureBtn') !== 'false'; // Default to true
  updateVentureButtonVisibility(showVentureBtn);
  
  // Initialize session form type dropdown
  updateSessionFormTypeDropdown();
  
  // Load user ventures from database
  loadUserVentures();
  
  // Add click outside to close functionality
  const settingsModal = document.getElementById('settingsModal');
  if (settingsModal) {
    settingsModal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeSettingsModal();
      }
    });
  }
});

async function loadUserVentures() {
  try {
    const response = await fetch('/api/user_ventures');
    const userVentures = await response.json();
    
    // Add user ventures to sidebar if they don't already exist
    const ventureList = document.querySelector('.sidebar ul');
    if (ventureList) {
      const existingVentures = Array.from(ventureList.querySelectorAll('li')).map(li => li.textContent.trim());
      
      userVentures.forEach(ventureType => {
        if (!existingVentures.includes(ventureType)) {
          const newVentureItem = document.createElement('li');
          newVentureItem.style.color = '#aaa';
          newVentureItem.style.padding = '0.25rem 0';
          newVentureItem.style.borderBottom = '1px solid #222';
          
          // Create the venture link based on type
          let ventureLink;
          if (ventureType === 'Blackjack') {
            ventureLink = document.createElement('a');
            ventureLink.href = '/blackjack';
            ventureLink.style.color = '#00ffff';
            ventureLink.style.textDecoration = 'none';
            ventureLink.style.fontWeight = 'bold';
            ventureLink.textContent = 'Blackjack';
          } else if (ventureType === 'Poker') {
            ventureLink = document.createElement('a');
            ventureLink.href = '/poker';
            ventureLink.style.color = '#ff66cc';
            ventureLink.style.textDecoration = 'none';
            ventureLink.style.fontWeight = 'bold';
            ventureLink.textContent = 'Poker';
          } else if (ventureType === 'Match Play') {
            ventureLink = document.createElement('a');
            ventureLink.href = '/matchplay';
            ventureLink.style.color = '#ffaa00';
            ventureLink.style.textDecoration = 'none';
            ventureLink.style.fontWeight = 'bold';
            ventureLink.textContent = 'Match Play';
          } else {
            // For other venture types, just show as text
            ventureLink = document.createTextNode(ventureType);
          }
          
          newVentureItem.appendChild(ventureLink);
          ventureList.appendChild(newVentureItem);
        }
      });
    }
    
    // Update session form dropdown after loading ventures
    updateSessionFormTypeDropdown();
  } catch (error) {
    console.error('Error loading user ventures:', error);
  }
}

async function loadVenturesForManagement() {
  try {
    const response = await fetch('/api/user_ventures');
    const userVentures = await response.json();
    
    const ventureList = document.getElementById('venture-management-list');
    if (!ventureList) return;
    
    if (userVentures.length === 0) {
      ventureList.innerHTML = '<div class="no-ventures">No ventures added yet</div>';
      return;
    }
    
    ventureList.innerHTML = '';
    
    userVentures.forEach(ventureType => {
      const ventureItem = document.createElement('div');
      ventureItem.className = 'venture-item';
      
      // Get venture color
      let ventureColor = '#666';
      if (ventureType === 'Blackjack') ventureColor = '#00ffff';
      else if (ventureType === 'Poker') ventureColor = '#ff66cc';
      else if (ventureType === 'Match Play') ventureColor = '#ffaa00';
      
      ventureItem.innerHTML = `
        <div class="venture-info">
          <div class="venture-color" style="background-color: ${ventureColor};"></div>
          <span class="venture-name">${ventureType}</span>
        </div>
        <button class="delete-venture-btn" onclick="deleteVenture('${ventureType}')">Delete</button>
      `;
      
      ventureList.appendChild(ventureItem);
    });
  } catch (error) {
    console.error('Error loading ventures for management:', error);
  }
}

async function deleteVenture(ventureType) {
  if (!confirm(`Are you sure you want to delete the "${ventureType}" venture? This will remove it from your sidebar but won't delete any session data.`)) {
    return;
  }
  
  try {
    const response = await fetch(`/api/user_ventures/${encodeURIComponent(ventureType)}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Remove from sidebar
      const ventureList = document.querySelector('.sidebar ul');
      if (ventureList) {
        const ventureItems = ventureList.querySelectorAll('li');
        ventureItems.forEach(item => {
          if (item.textContent.trim() === ventureType) {
            item.remove();
          }
        });
      }
      
      // Update session form dropdown
      updateSessionFormTypeDropdown();
      
      // Reload venture management list
      loadVenturesForManagement();
      
      alert(`${ventureType} venture deleted successfully!`);
    } else {
      alert(`Error deleting venture: ${result.error}`);
    }
  } catch (error) {
    console.error('Error deleting venture:', error);
    alert('Error deleting venture. Please try again.');
  }
}
</script>

<script>
const pokerBlackjackQuotes = [
  "Poker is a hard way to make an easy living. â€“ Doyle Brunson",
  "The commonest mistake in history is underestimating your opponent; it happens at the poker table all the time. â€“ David Shoup",
  "If you can't spot the sucker in your first half hour at the table, then you are the sucker. â€“ Matt Damon (Rounders)",
  "The beautiful thing about poker is that everybody thinks they can play. â€“ Chris Moneymaker",
  "In the long run, there's no luck in poker, but the short run is longer than most people know. â€“ Rick Bennet",
  "Blackjack is the only casino game where the odds can be in your favor. â€“ Edward O. Thorp",
  "The house doesn't beat the player. It just gives him the opportunity to beat himself. â€“ Nicholas Dandolos",
  "The smarter you play, the luckier you'll be. â€“ Mark Pilarski",
  "Fold and live to fold again. â€“ Stu Ungar",
  "Luck is what happens when preparation meets opportunity. â€“ Seneca"
];
function showRandomQuote() {
  const quote = pokerBlackjackQuotes[Math.floor(Math.random() * pokerBlackjackQuotes.length)];
  document.getElementById('quote-box').textContent = quote;
}
document.addEventListener('DOMContentLoaded', showRandomQuote);

// Feedback Modal Functions
function openFeedbackModal() {
  document.getElementById('feedbackModal').style.display = 'flex';
  document.getElementById('feedbackForm').reset();
  document.getElementById('significanceGuide').textContent = '';
}

function closeFeedbackModal() {
  document.getElementById('feedbackModal').style.display = 'none';
}

// Update significance guide based on feedback type
document.getElementById('feedbackType').addEventListener('change', function() {
  updateSignificanceGuide();
});

document.getElementById('significance').addEventListener('change', function() {
  updateSignificanceGuide();
});

function updateSignificanceGuide() {
  const feedbackType = document.getElementById('feedbackType').value;
  const significance = document.getElementById('significance').value;
  const guide = document.getElementById('significanceGuide');
  
  if (!feedbackType || !significance) {
    guide.textContent = '';
    return;
  }
  
  const guides = {
    'Bug Report': {
      '1': 'Minor visual issue or typo',
      '2': 'Small functionality issue',
      '3': 'Moderate bug affecting some users',
      '4': 'Major bug affecting many users',
      '5': 'Site-breaking bug or security issue'
    },
    'Feature Request': {
      '1': 'Nice-to-have enhancement',
      '2': 'Small improvement',
      '3': 'Useful feature for many users',
      '4': 'Important feature that would improve the site significantly',
      '5': 'Would make the site amazing - game-changing feature'
    }
  };
  
  guide.textContent = guides[feedbackType][significance] || '';
}

async function submitFeedback(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const submitButton = event.target.querySelector('button[type="submit"]');
  const originalText = submitButton.textContent;
  
  // Disable button and show loading
  submitButton.disabled = true;
  submitButton.textContent = 'Submitting...';
  
  try {
    const response = await fetch('/submit_feedback', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('Thank you for your feedback! We\'ll review it and get back to you soon.');
      closeFeedbackModal();
    } else {
      alert('Error submitting feedback: ' + result.message);
    }
  } catch (error) {
    alert('Error submitting feedback. Please try again.');
    console.error('Feedback submission error:', error);
  } finally {
    // Re-enable button
    submitButton.disabled = false;
    submitButton.textContent = originalText;
  }
}

// Close modal when clicking outside
document.getElementById('feedbackModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeFeedbackModal();
  }
});
</script>

<!-- Place the ticker bar and script at the very end, outside all containers -->

<style>
@keyframes ticker-scroll {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}
#session-ticker {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100vw;
  overflow-x: hidden;
  background: #101010;
  border-top: 1px solid #222;
  margin: 0;
  padding: 0;
  height: 2.2em;
  z-index: 1000;
}
#ticker-inner {
  white-space: nowrap;
  display: inline-block;
  position: absolute;
  left: 0;
  top: 0;
  will-change: transform;
  padding: 0;
  margin: 0;
  animation: ticker-scroll linear infinite;
  animation-duration: 30s;
}
</style>

<div id="session-ticker">
  <div id="ticker-inner"></div>
</div>

<script>
function renderTicker(sessions) {
  const ticker = document.getElementById('ticker-inner');
  ticker.innerHTML = '';
  if (!sessions.length) {
    ticker.innerHTML = '<span style="color:#888; font-family:JetBrains Mono,monospace;">No recent sessions to display.</span>';
    ticker.style.animation = 'none';
    return;
  }
  let contentHTML = '';
  sessions.forEach(s => {
    const color = s.amount >= 0 ? '#00ff99' : '#ff4444';
    const sign = s.amount >= 0 ? '+' : '';
    contentHTML +=
      `<span style='display:inline-block; margin-right:2.5em; font-family:JetBrains Mono, Consolas, monospace; font-size:1.1em; color:#fff;'>` +
      `<span style='color:#aaa;'>[${s.type}]</span> ` +
      `<span style='color:${color};'>${sign}$${Math.abs(s.amount)}</span> | ` +
      `<span style='color:#66ccff;'>${s.hours}h</span> | ` +
      `<span style='color:#ffaa00;'>${s.date}</span>` +
      `</span>`;
  });
  // Duplicate the content for seamless looping
  ticker.innerHTML = contentHTML + contentHTML;
  // Set animation duration based on content width for consistent speed
  const pxPerSec = 60; // adjust for speed
  const duration = (ticker.scrollWidth / 2) / pxPerSec;
  ticker.style.animationDuration = duration + 's';
  ticker.style.animationName = 'ticker-scroll';
}

fetch('/api/recent_sessions')
  .then(r => r.json())
  .then(data => {
    renderTicker(data);
  });
</script>

  <!-- Chart.js and data bindings -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <script>
    const chartData = JSON.parse('{{ chart_data | tojson | safe }}');
    const combinedBankrollData = JSON.parse('{{ combined_chart_data | tojson | safe }}');
    const ventureChartData = {{ venture_chart_data | tojson | safe }};
  </script>

  <script src="{{ url_for('static', filename='chart.js') }}"></script>

  <script>
    function toggleSessionForm() {
      const form = document.getElementById('sessionForm');
      form.classList.toggle('hidden');
    }
  </script>

  <script>
    function toggleSessionForm() {
      const form = document.getElementById('sessionForm');
      form.classList.toggle('hidden');

      if (!form.classList.contains('hidden')) {
        const dateField = document.getElementById('dateInput');
        if (dateField) {
          const today = new Date().toISOString().split('T')[0];
          dateField.value = today;
        }

        document.querySelectorAll('.lock-btn').forEach(btn => {
          const inputId = btn.dataset.target;
          const input = document.getElementById(inputId);
          const locked = localStorage.getItem(`${inputId}_locked`) === 'true';
          const value = localStorage.getItem(`${inputId}_value`);
          if (locked && value !== null) {
            input.value = value;
          }
          btn.innerText = locked ? 'ðŸ”’' : 'ðŸ”“';
        });
      }
    }

    document.querySelectorAll('.lock-btn').forEach(button => {
      button.addEventListener('click', () => {
        const targetId = button.dataset.target;
        const input = document.getElementById(targetId);
        const isLocked = localStorage.getItem(`${targetId}_locked`) === 'true';

        if (isLocked) {
          localStorage.setItem(`${targetId}_locked`, 'false');
          localStorage.removeItem(`${targetId}_value`);
          button.innerText = 'ðŸ”“';
        } else {
          localStorage.setItem(`${targetId}_locked`, 'true');
          localStorage.setItem(`${targetId}_value`, input.value);
          button.innerText = 'ðŸ”’';
        }
      });
    });
  </script>

{% endblock %}

<!-- Toggle for Tips Included in P/L -->
<style>
.custom-slider-switch {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 28px;
}
.custom-slider-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.custom-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #333;
  transition: .4s;
  border-radius: 28px;
}
.custom-slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background-color: #00ff99;
  transition: .4s;
  border-radius: 50%;
}
.custom-slider-switch input:checked + .custom-slider {
  background-color: #00ff99;
}
.custom-slider-switch input:checked + .custom-slider:before {
  transform: translateX(20px);
  background: #111;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const tipsToggle = document.getElementById('tips-toggle');
  if (tipsToggle) {
    // Set initial state from localStorage
    const stored = localStorage.getItem('tips_included');
    if (stored !== null) {
      tipsToggle.checked = stored === '1';
    }
    tipsToggle.addEventListener('change', function() {
      localStorage.setItem('tips_included', this.checked ? '1' : '0');
      const url = new URL(window.location.href);
      if (this.checked) {
        url.searchParams.set('tips_included', '1');
      } else {
        url.searchParams.set('tips_included', '0');
      }
      window.location.href = url.toString();
    });
    // If the query param doesn't match localStorage, update the URL
    const url = new URL(window.location.href);
    const param = url.searchParams.get('tips_included');
    if (stored !== null && param !== stored) {
      url.searchParams.set('tips_included', stored);
      window.location.replace(url.toString());
    }
  }
});
</script>



<script>
// Add venture button functionality (placeholder for now)
document.addEventListener('DOMContentLoaded', function() {
  const addVentureBtn = document.getElementById('add-venture-btn');
  if (addVentureBtn) {
    addVentureBtn.addEventListener('click', function() {
      // This will be implemented later
      console.log('Add venture button clicked');
    });
  }
});
</script>
