{% extends 'base.html' %}

{% block content %}

<div class="container">
  <h1>Dashboard</h1>

  <div class="button-row">
    <button class="btn btn-outline-green" onclick="toggleSessionForm()">New Session</button>
    <a href="{{ url_for('view_logs') }}" class="btn">View Logs</a>
    <a href="{{ url_for('view_banking') }}" class="btn">Banking</a>
    <a href="{{ url_for('view_comps') }}" class="btn">Comps</a>
    <a href="{{ url_for('view_locations') }}" class="btn">Locations</a>

    <a href="{{ url_for('login')}}" class="btn btn-outline-red" style="margin-left:auto">Logout</a>

    
  </div>

  <!-- Collapsible session form -->
  <div id="sessionForm" class="session-form hidden" style="margin-left:-0.60rem;">
    <form method="POST" action="/add_session">
      <div class="form-grid">
        <div class="input-lock-container">
          <input type="date" name="date" id="dateInput" required>
        </div>
        <div class="input-lock-container">
          <input type="text" name="location" id="locationInput" placeholder="Location">
          <button type="button" class="lock-btn" data-target="locationInput">ðŸ”’</button>
        </div>
        <div class="input-lock-container">
          <input type="text" name="type" id="typeInput" placeholder="Type">
          <button type="button" class="lock-btn" data-target="typeInput">ðŸ”’</button>
        </div>
        <div class="input-lock-container">
          <input type="text" name="stakes" id="stakesInput" placeholder="Stakes">
          <button type="button" class="lock-btn" data-target="stakesInput">ðŸ”’</button>
        </div>

        <input type="time" name="time_in" placeholder="Time In">
        <input type="time" name="time_out" placeholder="Time Out">
        <input type="number" name="money_in" placeholder="Money In" step="0.01">
        <input type="number" name="money_out" placeholder="Money Out" step="0.01">

        <div class="input-lock-container">
          <input type="number" name="comps_in" id="compsInInput" placeholder="Comps In" step="0.01">
          <button type="button" class="lock-btn" data-target="compsInInput">ðŸ”’</button>
        </div>
        <div class="input-lock-container">
          <input type="number" name="comps_out" id="compsOutInput" placeholder="Comps Out" step="0.01">
          <button type="button" class="lock-btn" data-target="compsOutInput">ðŸ”’</button>
        </div>

        <input type="number" name="tips" placeholder="Tips" step="0.01">
      </div>
      <button type="submit" class="btn">Submit</button>
    </form>
  </div>

  <!-- Sidebar + All Charts (Top & Bottom) -->
  <div class="main-content">

    
    <!-- Sidebar -->
    <div class="sidebar" style="width: 200px; background-color: #111; padding: 1rem; border-radius: 10px; max-height: 90vh;">
      <h3 style="color: #ffffff; font-family: Consolas, monospace;">Ventures</h3>
      <ul style="list-style: none; padding-left: 0;">
        {% for type in unique_types %}
          <li style="color: #aaa; padding: 0.25rem 0; border-bottom: 1px solid #222;">{{ type }}</li>
        {% endfor %}
      </ul>
    </div>

    <!-- Right column: all charts -->
<div class="dashboard-grid">
  <!-- Top Row -->
  <div class="chart chart-wide">
    <div class="chart-label green">Cumulative Profit (PnL)</div>
    <canvas id="profitChart"></canvas>
  </div>

  <div class="chart chart-wide">
    <div class="chart-label blue">Total Bankroll by Date</div>
    <canvas id="combinedBankrollChart"></canvas>
  </div>

  
  <!-- Bottom Row: Venture Charts (each appended as a .chart.chart-narrow) -->
<div id="ventureCharts" class="venture-grid"></div>

</div>

</div> <!-- End of .container or main content -->

<!-- QUOTE CONTAINER: Centered between charts and ticker, not under sidebar -->
<div id="quote-container" style="position: absolute; left: 300px; right: 40px; margin: 0 auto; bottom: 3.8em; width: auto; max-width: none; min-width: 300px; z-index: 900; text-align: center;">
  <div id="quote-box" style="background: #181818; color: #fff; border-radius: 10px; border: 1px solid #333; width: 100%; height: 4em; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; justify-content: center; font-size: 1em; font-family: 'JetBrains Mono', Consolas, monospace; box-shadow: 0 2px 12px #000a;">
    <!-- Quote will be inserted here -->
  </div>
</div>

<script>
const pokerBlackjackQuotes = [
  "Poker is a hard way to make an easy living. â€“ Doyle Brunson",
  "The commonest mistake in history is underestimating your opponent; it happens at the poker table all the time. â€“ David Shoup",
  "If you can't spot the sucker in your first half hour at the table, then you are the sucker. â€“ Matt Damon (Rounders)",
  "The beautiful thing about poker is that everybody thinks they can play. â€“ Chris Moneymaker",
  "In the long run, there's no luck in poker, but the short run is longer than most people know. â€“ Rick Bennet",
  "Blackjack is the only casino game where the odds can be in your favor. â€“ Edward O. Thorp",
  "The house doesn't beat the player. It just gives him the opportunity to beat himself. â€“ Nicholas Dandolos",
  "The smarter you play, the luckier you'll be. â€“ Mark Pilarski",
  "Fold and live to fold again. â€“ Stu Ungar",
  "Luck is what happens when preparation meets opportunity. â€“ Seneca"
];
function showRandomQuote() {
  const quote = pokerBlackjackQuotes[Math.floor(Math.random() * pokerBlackjackQuotes.length)];
  document.getElementById('quote-box').textContent = quote;
}
document.addEventListener('DOMContentLoaded', showRandomQuote);
</script>

<!-- Place the ticker bar and script at the very end, outside all containers -->

<style>
@keyframes ticker-scroll {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}
#session-ticker {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100vw;
  overflow-x: hidden;
  background: #101010;
  border-top: 1px solid #222;
  margin: 0;
  padding: 0;
  height: 2.2em;
  z-index: 1000;
}
#ticker-inner {
  white-space: nowrap;
  display: inline-block;
  position: absolute;
  left: 0;
  top: 0;
  will-change: transform;
  padding: 0;
  margin: 0;
  animation: ticker-scroll linear infinite;
  animation-duration: 30s;
}
</style>

<div id="session-ticker">
  <div id="ticker-inner"></div>
</div>

<script>
function renderTicker(sessions) {
  const ticker = document.getElementById('ticker-inner');
  ticker.innerHTML = '';
  if (!sessions.length) {
    ticker.innerHTML = '<span style="color:#888; font-family:JetBrains Mono,monospace;">No recent sessions to display.</span>';
    ticker.style.animation = 'none';
    return;
  }
  let contentHTML = '';
  sessions.forEach(s => {
    const color = s.amount >= 0 ? '#00ff99' : '#ff4444';
    const sign = s.amount >= 0 ? '+' : '';
    contentHTML +=
      `<span style='display:inline-block; margin-right:2.5em; font-family:JetBrains Mono, Consolas, monospace; font-size:1.1em; color:#fff;'>` +
      `<span style='color:#aaa;'>[${s.type}]</span> ` +
      `<span style='color:${color};'>${sign}$${Math.abs(s.amount)}</span> | ` +
      `<span style='color:#66ccff;'>${s.hours}h</span> | ` +
      `<span style='color:#ffaa00;'>${s.date}</span>` +
      `</span>`;
  });
  // Duplicate the content for seamless looping
  ticker.innerHTML = contentHTML + contentHTML;
  // Set animation duration based on content width for consistent speed
  const pxPerSec = 60; // adjust for speed
  const duration = (ticker.scrollWidth / 2) / pxPerSec;
  ticker.style.animationDuration = duration + 's';
  ticker.style.animationName = 'ticker-scroll';
}

fetch('/api/recent_sessions')
  .then(r => r.json())
  .then(data => {
    renderTicker(data);
  });
</script>

  <!-- Chart.js and data bindings -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <script>
    const chartData = JSON.parse('{{ chart_data | tojson | safe }}');
    const combinedBankrollData = JSON.parse('{{ combined_chart_data | tojson | safe }}');
    const ventureChartData = {{ venture_chart_data | tojson | safe }};
  </script>

  <script src="{{ url_for('static', filename='chart.js') }}"></script>

  <script>
    function toggleSessionForm() {
      const form = document.getElementById('sessionForm');
      form.classList.toggle('hidden');
    }
  </script>

  <script>
    function toggleSessionForm() {
      const form = document.getElementById('sessionForm');
      form.classList.toggle('hidden');

      if (!form.classList.contains('hidden')) {
        const dateField = document.getElementById('dateInput');
        if (dateField) {
          const today = new Date().toISOString().split('T')[0];
          dateField.value = today;
        }

        document.querySelectorAll('.lock-btn').forEach(btn => {
          const inputId = btn.dataset.target;
          const input = document.getElementById(inputId);
          const locked = localStorage.getItem(`${inputId}_locked`) === 'true';
          const value = localStorage.getItem(`${inputId}_value`);
          if (locked && value !== null) {
            input.value = value;
          }
          btn.innerText = locked ? 'ðŸ”’' : 'ðŸ”“';
        });
      }
    }

    document.querySelectorAll('.lock-btn').forEach(button => {
      button.addEventListener('click', () => {
        const targetId = button.dataset.target;
        const input = document.getElementById(targetId);
        const isLocked = localStorage.getItem(`${targetId}_locked`) === 'true';

        if (isLocked) {
          localStorage.setItem(`${targetId}_locked`, 'false');
          localStorage.removeItem(`${targetId}_value`);
          button.innerText = 'ðŸ”“';
        } else {
          localStorage.setItem(`${targetId}_locked`, 'true');
          localStorage.setItem(`${targetId}_value`, input.value);
          button.innerText = 'ðŸ”’';
        }
      });
    });
  </script>

{% endblock %}
