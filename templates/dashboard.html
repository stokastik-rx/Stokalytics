{% extends 'base.html' %}

{% block body_class %}dashboard-page{% endblock %}

{% block content %}

<div class="container">
  <h1>Dashboard</h1>

  <div class="button-row" style="display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; gap: 10px; align-items: center;">
      <button class="btn btn-outline-green" onclick="toggleSessionForm()">New Session</button>
      <a href="{{ url_for('view_logs') }}" class="btn">View Logs</a>
      <a href="{{ url_for('view_banking') }}" class="btn">Banking</a>
      <a href="{{ url_for('view_comps') }}" class="btn">Comps</a>
      <a href="{{ url_for('view_locations') }}" class="btn">Locations</a>
    </div>
    <div style="display: flex; gap: 10px; align-items: center;">
      <a href="{{ url_for('donate') }}" class="btn" style="margin-right: 0;">Support Development</a>
      <button class="btn" onclick="openFeedbackModal()">Give Feedback</button>
      <a href="#" class="btn">Settings</a>
      <a href="{{ url_for('logout')}}" class="btn btn-outline-red">Logout</a>
    </div>
  </div>

  <!-- Collapsible session form -->
  <div id="sessionForm" class="session-form hidden" style="margin-left:-0.60rem;">
    <form method="POST" action="/add_session">
      <div class="form-grid">
        <div class="input-lock-container">
          <input type="date" name="date" id="dateInput" required>
        </div>
        <div class="input-lock-container">
          <input type="text" name="location" id="locationInput" placeholder="Location">
          <button type="button" class="lock-btn" data-target="locationInput">üîí</button>
        </div>
        <div class="input-lock-container">
          <input type="text" name="type" id="typeInput" placeholder="Type">
          <button type="button" class="lock-btn" data-target="typeInput">üîí</button>
        </div>
        <div class="input-lock-container">
          <input type="text" name="stakes" id="stakesInput" placeholder="Stakes">
          <button type="button" class="lock-btn" data-target="stakesInput">üîí</button>
        </div>

        <input type="time" name="time_in" placeholder="Time In">
        <input type="time" name="time_out" placeholder="Time Out">
        <input type="number" name="money_in" placeholder="Money In" step="0.01">
        <input type="number" name="money_out" placeholder="Money Out" step="0.01">

        <div class="input-lock-container">
          <input type="number" name="comps_in" id="compsInInput" placeholder="Comps In" step="0.01">
          <button type="button" class="lock-btn" data-target="compsInInput">üîí</button>
        </div>
        <div class="input-lock-container">
          <input type="number" name="comps_out" id="compsOutInput" placeholder="Comps Out" step="0.01">
          <button type="button" class="lock-btn" data-target="compsOutInput">üîí</button>
        </div>

        <input type="number" name="tips" placeholder="Tips" step="0.01">
      </div>
      <button type="submit" class="btn">Submit</button>
    </form>
  </div>

  <!-- Sidebar + All Charts (Top & Bottom) -->
  <div class="main-content" style="display: flex; align-items: flex-start; gap: 2.5rem;">
    <!-- Sidebar Column: vertical flex for stacking -->
    <div class="sidebar-scroll" style="display: flex; flex-direction: column; align-items: stretch; gap: 0; height: calc(100vh - 70px); overflow-y: scroll; min-height: 0;">
      <div class="sidebar" style="width: 200px; background-color: #111; padding: 1rem; border-radius: 10px; font-size: 0.92em; height: auto; min-height: 0;">
        <h3 style="color: #ffffff; font-family: Consolas, monospace;">{% if game_preference == 'blackjack' %}üÉè Blackjack{% elif game_preference == 'poker' %}‚ô†Ô∏è Poker{% else %}Ventures{% endif %}</h3>
        <ul style="list-style: none; padding-left: 0;">
          {% for type in unique_types %}
            <li style="color: #aaa; padding: 0.25rem 0; border-bottom: 1px solid #222;">
              {% if type == 'Blackjack' %}
                <a href="{{ url_for('view_blackjack') }}" style="color: #00ffff; text-decoration: none; font-weight: bold;">Blackjack</a>
              {% elif type == 'Poker' %}
                <span style="color: #ff66cc; font-weight: bold;">Poker</span>
              {% else %}
                {{ type }}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
      <div class="sidebar" style="width: 200px; background-color: #111; padding: 1rem; border-radius: 10px; margin-top: 1.5rem; font-size: 0.90em; height: auto; min-height: 0;">
        <h3 style="color: #ffffff; font-family: Consolas, monospace;">All Time Statistics</h3>
        <ul style="list-style: none; padding-left: 0; color: #ccc; font-family: 'JetBrains Mono', monospace; font-size: 0.90em;">
          <li style="margin-bottom: 0.3em;">Total Hours Played: <span style="color:#00ccff; float:right;">{{ all_time_stats.total_hours }}</span></li>
          <li style="margin-bottom: 0.3em;">Total Profit: <span style="color:{% if all_time_stats.total_profit >= 0 %}#00ff99{% else %}#ff4444{% endif %}; float:right;">${{ all_time_stats.total_profit }}</span></li>
          <li style="margin-bottom: 0.3em;">Hourly Rate: <span style="color:{% if all_time_stats.hourly_rate >= 0 %}#00ff99{% else %}#ff4444{% endif %}; float:right;">${{ all_time_stats.hourly_rate }}</span></li>
          <li style="margin-bottom: 0.3em;">Best Session: <span style="color:#00ff99; float:right;">${{ all_time_stats.best_session }}</span></li>
          <li style="margin-bottom: 0.3em;">Worst Session: <span style="color:#ff4444; float:right;">${{ all_time_stats.worst_session }}</span></li>
          <li style="margin-bottom: 0.3em;">Comps Realized: <span style="color:#ffaa00; float:right;">${{ all_time_stats.comps_realized }}</span></li>
        </ul>
      </div>
      <!-- Personal Bests Panel -->
      <div class="sidebar" style="width: 200px; background-color: #111; padding: 1rem; border-radius: 10px; margin-top: 1.2rem; font-size: 0.89em; height: auto; min-height: 0;">
        <h3 style="color: #ffffff; font-family: Consolas, monospace;">Personal Bests</h3>
        <ul style="list-style: none; padding-left: 0; color: #ccc; font-family: 'JetBrains Mono', monospace; font-size: 0.89em;">
          <li style="margin-bottom: 0.3em;">Longest Winning Streak: <span style="color:#00ff99; float:right;">{{ personal_bests.longest_streak }}</span></li>
          <li style="margin-bottom: 0.3em;">Most Profitable Day: <span style="color:#00ff99; float:right;">${{ personal_bests.most_profitable_day[1] }}</span></li>
          <li style="margin-bottom: 0.3em;">Longest Session: <span style="color:#00ccff; float:right;">{{ personal_bests.longest_session }}h</span></li>
        </ul>
      </div>
      <!-- Reminders Panel -->
      <div class="sidebar" style="width: 200px; background-color: #111; padding: 1rem; border-radius: 10px; margin-top: 1.2rem; font-size: 0.89em; position: relative; min-height: 130px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">
          <h3 style="color: #ffffff; font-family: Consolas, monospace; margin: 0;">Reminders</h3>
          <button class="btn btn-outline-green" style="font-size: 0.85em; padding: 2px 8px; height: 1.7em; line-height: 1; margin-left: 0.5em;">Add Reminder</button>
        </div>
        <div style="color: #ffaa00; font-size: 1.1em; text-align: center; margin-top: 1em;">Coming soon!</div>
      </div>
    </div>
    <style>
    /* Custom scrollbar for sidebar - matches site style */
    .main-content > div[style*='flex-direction: column'] {
      scrollbar-width: thin;
      scrollbar-color: #444 #222;
    }
    .main-content > div[style*='flex-direction: column']::-webkit-scrollbar {
      width: 10px;
      background: #222;
      border-radius: 8px;
    }
    .main-content > div[style*='flex-direction: column']::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 8px;
      min-height: 40px;
    }
    .main-content > div[style*='flex-direction: column']::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    </style>
    <!-- Dashboard Charts -->
    <div class="dashboard-grid" style="flex: 1;">
      <!-- Top Row -->
      <div class="chart chart-wide">
        <div class="chart-label green">Cumulative Profit (PnL)</div>
        <canvas id="profitChart"></canvas>
      </div>
      <div class="chart chart-wide">
        <div class="chart-label blue">Total Bankroll by Date</div>
        <canvas id="combinedBankrollChart"></canvas>
      </div>
      <!-- Bottom Row: Venture Charts (each appended as a .chart.chart-narrow) -->
      <div id="ventureCharts" class="venture-grid"></div>
    </div>
  </div>

</div> <!-- End of .container or main content -->

<!-- Feedback Modal -->
<div id="feedbackModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 600px; width: 90%;">
    <h3 style="color: #fff; margin-bottom: 1.5rem; text-align: center;">Submit Feedback</h3>
    
    <form id="feedbackForm" onsubmit="submitFeedback(event)">
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">Feedback Type:</label>
        <select id="feedbackType" name="feedback_type" class="styled-select" required>
          <option value="">Select type...</option>
          <option value="Bug Report">Bug Report</option>
          <option value="Feature Request">Feature Request</option>
        </select>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">Significance (1-5):</label>
        <select id="significance" name="significance" class="styled-select" required>
          <option value="">Select significance...</option>
          <option value="1">1 - Minor</option>
          <option value="2">2 - Low</option>
          <option value="3">3 - Medium</option>
          <option value="4">4 - High</option>
          <option value="5">5 - Critical</option>
        </select>
        <div id="significanceGuide" style="color: #666; font-size: 0.9em; margin-top: 0.5rem;"></div>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">Subject:</label>
        <input type="text" id="subject" name="subject" class="styled-input" placeholder="Brief description of your feedback" required>
      </div>

      <div style="margin-bottom: 2rem;">
        <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">Message:</label>
        <textarea id="message" name="message" class="styled-input" rows="6" placeholder="Please provide detailed feedback..." required></textarea>
      </div>

      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button type="button" class="btn" style="background: #1a1a1a;" onclick="closeFeedbackModal()">
          Cancel
        </button>
        <button type="submit" class="btn btn-outline-green">
          Submit Feedback
        </button>
      </div>
    </form>
  </div>
</div>

<!-- QUOTE CONTAINER: Centered between charts and ticker, not under sidebar -->
<div id="quote-container" style="position: absolute; left: 300px; right: 40px; margin: 0 auto; bottom: 3.8em; width: auto; max-width: none; min-width: 300px; z-index: 900; text-align: center;">
  <div id="quote-box" style="background: #181818; color: #fff; border-radius: 10px; border: 1px solid #333; width: 100%; height: 4em; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; justify-content: center; font-size: 1em; font-family: 'JetBrains Mono', Consolas, monospace; box-shadow: 0 2px 12px #000a;">
    <!-- Quote will be inserted here -->
  </div>
</div>

<script>
const pokerBlackjackQuotes = [
  "Poker is a hard way to make an easy living. ‚Äì Doyle Brunson",
  "The commonest mistake in history is underestimating your opponent; it happens at the poker table all the time. ‚Äì David Shoup",
  "If you can't spot the sucker in your first half hour at the table, then you are the sucker. ‚Äì Matt Damon (Rounders)",
  "The beautiful thing about poker is that everybody thinks they can play. ‚Äì Chris Moneymaker",
  "In the long run, there's no luck in poker, but the short run is longer than most people know. ‚Äì Rick Bennet",
  "Blackjack is the only casino game where the odds can be in your favor. ‚Äì Edward O. Thorp",
  "The house doesn't beat the player. It just gives him the opportunity to beat himself. ‚Äì Nicholas Dandolos",
  "The smarter you play, the luckier you'll be. ‚Äì Mark Pilarski",
  "Fold and live to fold again. ‚Äì Stu Ungar",
  "Luck is what happens when preparation meets opportunity. ‚Äì Seneca"
];
function showRandomQuote() {
  const quote = pokerBlackjackQuotes[Math.floor(Math.random() * pokerBlackjackQuotes.length)];
  document.getElementById('quote-box').textContent = quote;
}
document.addEventListener('DOMContentLoaded', showRandomQuote);

// Feedback Modal Functions
function openFeedbackModal() {
  document.getElementById('feedbackModal').style.display = 'flex';
  document.getElementById('feedbackForm').reset();
  document.getElementById('significanceGuide').textContent = '';
}

function closeFeedbackModal() {
  document.getElementById('feedbackModal').style.display = 'none';
}

// Update significance guide based on feedback type
document.getElementById('feedbackType').addEventListener('change', function() {
  updateSignificanceGuide();
});

document.getElementById('significance').addEventListener('change', function() {
  updateSignificanceGuide();
});

function updateSignificanceGuide() {
  const feedbackType = document.getElementById('feedbackType').value;
  const significance = document.getElementById('significance').value;
  const guide = document.getElementById('significanceGuide');
  
  if (!feedbackType || !significance) {
    guide.textContent = '';
    return;
  }
  
  const guides = {
    'Bug Report': {
      '1': 'Minor visual issue or typo',
      '2': 'Small functionality issue',
      '3': 'Moderate bug affecting some users',
      '4': 'Major bug affecting many users',
      '5': 'Site-breaking bug or security issue'
    },
    'Feature Request': {
      '1': 'Nice-to-have enhancement',
      '2': 'Small improvement',
      '3': 'Useful feature for many users',
      '4': 'Important feature that would improve the site significantly',
      '5': 'Would make the site amazing - game-changing feature'
    }
  };
  
  guide.textContent = guides[feedbackType][significance] || '';
}

async function submitFeedback(event) {
  event.preventDefault();
  
  const formData = new FormData(event.target);
  const submitButton = event.target.querySelector('button[type="submit"]');
  const originalText = submitButton.textContent;
  
  // Disable button and show loading
  submitButton.disabled = true;
  submitButton.textContent = 'Submitting...';
  
  try {
    const response = await fetch('/submit_feedback', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert('Thank you for your feedback! We\'ll review it and get back to you soon.');
      closeFeedbackModal();
    } else {
      alert('Error submitting feedback: ' + result.message);
    }
  } catch (error) {
    alert('Error submitting feedback. Please try again.');
    console.error('Feedback submission error:', error);
  } finally {
    // Re-enable button
    submitButton.disabled = false;
    submitButton.textContent = originalText;
  }
}

// Close modal when clicking outside
document.getElementById('feedbackModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeFeedbackModal();
  }
});
</script>

<!-- Place the ticker bar and script at the very end, outside all containers -->

<style>
@keyframes ticker-scroll {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}
#session-ticker {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100vw;
  overflow-x: hidden;
  background: #101010;
  border-top: 1px solid #222;
  margin: 0;
  padding: 0;
  height: 2.2em;
  z-index: 1000;
}
#ticker-inner {
  white-space: nowrap;
  display: inline-block;
  position: absolute;
  left: 0;
  top: 0;
  will-change: transform;
  padding: 0;
  margin: 0;
  animation: ticker-scroll linear infinite;
  animation-duration: 30s;
}
</style>

<div id="session-ticker">
  <div id="ticker-inner"></div>
</div>

<script>
function renderTicker(sessions) {
  const ticker = document.getElementById('ticker-inner');
  ticker.innerHTML = '';
  if (!sessions.length) {
    ticker.innerHTML = '<span style="color:#888; font-family:JetBrains Mono,monospace;">No recent sessions to display.</span>';
    ticker.style.animation = 'none';
    return;
  }
  let contentHTML = '';
  sessions.forEach(s => {
    const color = s.amount >= 0 ? '#00ff99' : '#ff4444';
    const sign = s.amount >= 0 ? '+' : '';
    contentHTML +=
      `<span style='display:inline-block; margin-right:2.5em; font-family:JetBrains Mono, Consolas, monospace; font-size:1.1em; color:#fff;'>` +
      `<span style='color:#aaa;'>[${s.type}]</span> ` +
      `<span style='color:${color};'>${sign}$${Math.abs(s.amount)}</span> | ` +
      `<span style='color:#66ccff;'>${s.hours}h</span> | ` +
      `<span style='color:#ffaa00;'>${s.date}</span>` +
      `</span>`;
  });
  // Duplicate the content for seamless looping
  ticker.innerHTML = contentHTML + contentHTML;
  // Set animation duration based on content width for consistent speed
  const pxPerSec = 60; // adjust for speed
  const duration = (ticker.scrollWidth / 2) / pxPerSec;
  ticker.style.animationDuration = duration + 's';
  ticker.style.animationName = 'ticker-scroll';
}

fetch('/api/recent_sessions')
  .then(r => r.json())
  .then(data => {
    renderTicker(data);
  });
</script>

  <!-- Chart.js and data bindings -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <script>
    const chartData = JSON.parse('{{ chart_data | tojson | safe }}');
    const combinedBankrollData = JSON.parse('{{ combined_chart_data | tojson | safe }}');
    const ventureChartData = {{ venture_chart_data | tojson | safe }};
  </script>

  <script src="{{ url_for('static', filename='chart.js') }}"></script>

  <script>
    function toggleSessionForm() {
      const form = document.getElementById('sessionForm');
      form.classList.toggle('hidden');
    }
  </script>

  <script>
    function toggleSessionForm() {
      const form = document.getElementById('sessionForm');
      form.classList.toggle('hidden');

      if (!form.classList.contains('hidden')) {
        const dateField = document.getElementById('dateInput');
        if (dateField) {
          const today = new Date().toISOString().split('T')[0];
          dateField.value = today;
        }

        document.querySelectorAll('.lock-btn').forEach(btn => {
          const inputId = btn.dataset.target;
          const input = document.getElementById(inputId);
          const locked = localStorage.getItem(`${inputId}_locked`) === 'true';
          const value = localStorage.getItem(`${inputId}_value`);
          if (locked && value !== null) {
            input.value = value;
          }
          btn.innerText = locked ? 'üîí' : 'üîì';
        });
      }
    }

    document.querySelectorAll('.lock-btn').forEach(button => {
      button.addEventListener('click', () => {
        const targetId = button.dataset.target;
        const input = document.getElementById(targetId);
        const isLocked = localStorage.getItem(`${targetId}_locked`) === 'true';

        if (isLocked) {
          localStorage.setItem(`${targetId}_locked`, 'false');
          localStorage.removeItem(`${targetId}_value`);
          button.innerText = 'üîì';
        } else {
          localStorage.setItem(`${targetId}_locked`, 'true');
          localStorage.setItem(`${targetId}_value`, input.value);
          button.innerText = 'üîí';
        }
      });
    });
  </script>

{% endblock %}

<script>
function toggleReminderForm(e) {
  e.preventDefault();
  var form = document.getElementById('reminderForm');
  form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
  if (form.style.display === 'block') {
    form.querySelector('input[name=reminder]').focus();
  }
}
</script>
