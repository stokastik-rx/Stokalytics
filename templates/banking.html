{% extends 'base.html' %}

{% block content %}
<div class="container">
  <h1>Banking</h1>

  <div class="button-row" style="display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; gap: 10px; align-items: center;">
      <a href="{{ url_for('dashboard') }}" class="btn">Back to Dashboard</a>
      <button class="btn" id="openBankModalBtn">Add Bank</button>
      <button class="btn btn-outline-green" id="openDepositModalBtn">Deposit</button>
      <button class="btn btn-outline-red" id="openWithdrawalModalBtn">Withdrawal</button>
    </div>
    <div style="display: flex; gap: 10px; align-items: center;">
      <a href="{{ url_for('donate') }}" class="btn" style="margin-right: 0;">Support Development</a>
      <button class="btn" onclick="openFeedbackModal()">Give Feedback</button>
      <button class="btn" onclick="openSettingsModal()">Settings</button>
      <a href="{{ url_for('logout')}}" class="btn btn-outline-red">Logout</a>
    </div>
  </div>

  <!-- Deposit Modal -->
<div id="depositModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 400px; width: 90%; position: relative;">
    <button type="button" class="modal-close-btn" onclick="closeModal('depositModal')" style="position: absolute; top: 16px; right: 18px; background: none; border: none; color: #fff; font-size: 1.7rem; cursor: pointer;">&times;</button>
    <h3 style="color: #fff; margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">Deposit</h3>
    <form method="POST" action="{{ url_for('update_ledger') }}" id="depositFormModal">
      <div class="form-group" style="display: flex; flex-direction: column; gap: 1.1rem;">
        <div style="display: flex; align-items: center; gap: 0.6rem;">
          <select name="venture" id="depositVentureSelect" required class="custom-select compact-select" style="flex: 1 1 0; min-width: 0;">
            <!-- Options populated by JS -->
          </select>
          <span style="color: #00ff99; font-size: 1.3rem; margin: 0 0.15rem;">&#8594;</span>
          <select name="account" required class="custom-select compact-select" style="flex: 1 1 0; min-width: 0;">
            {% for bank in banks %}
              <option value="{{ bank.name }}">{{ bank.name }}</option>
            {% endfor %}
          </select>
        </div>
        <input type="number" name="deposit" step="0.01" required placeholder="Amount" class="compact-input" style="width: 95%; margin: 0 auto; background-color: #111; color: #fff; border: 1px solid #333; font-family: 'JetBrains Mono', monospace; padding: 0.45rem; font-size: 0.98rem; border-radius: 7px;">
        <input type="hidden" name="date" value="{{ datetime.utcnow().date() }}">
        <button type="submit" class="btn" style="margin-top: 1.1rem; width: 100%; font-size: 1.1rem;">Submit</button>
      </div>
    </form>
  </div>
</div>

<!-- Withdrawal Modal -->
<div id="withdrawalModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 400px; width: 90%; position: relative;">
    <button type="button" class="modal-close-btn" onclick="closeModal('withdrawalModal')" style="position: absolute; top: 16px; right: 18px; background: none; border: none; color: #fff; font-size: 1.7rem; cursor: pointer;">&times;</button>
    <h3 style="color: #fff; margin-bottom: 1.5rem; font-family: 'JetBrains Mono', monospace;">Withdrawal</h3>
    <form method="POST" action="{{ url_for('update_ledger') }}" id="withdrawalFormModal">
      <div class="form-group" style="display: flex; flex-direction: column; gap: 1.1rem;">
        <div style="display: flex; align-items: center; gap: 0.6rem;">
          <select name="account" required class="custom-select compact-select" style="flex: 1 1 0; min-width: 0;">
            {% for bank in banks %}
              <option value="{{ bank.name }}">{{ bank.name }}</option>
            {% endfor %}
          </select>
          <span style="color: #ff4444; font-size: 1.3rem; margin: 0 0.15rem;">&#8594;</span>
          <select name="venture" id="withdrawalVentureSelect" required class="custom-select compact-select" style="flex: 1 1 0; min-width: 0;">
            <!-- Options populated by JS -->
          </select>
        </div>
        <input type="number" name="withdrawal" step="0.01" required placeholder="Amount" class="compact-input" style="width: 95%; margin: 0 auto; background-color: #111; color: #fff; border: 1px solid #333; font-family: 'JetBrains Mono', monospace; padding: 0.45rem; font-size: 0.98rem; border-radius: 7px;">
        <input type="hidden" name="date" value="{{ datetime.utcnow().date() }}">
        <button type="submit" class="btn" style="margin-top: 1.1rem; width: 100%; font-size: 1.1rem;">Submit</button>
      </div>
    </form>
  </div>
</div>

<!-- Remove default dropdown arrows for custom-select and make compact -->
<style>
.custom-select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: none !important;
  background: #111;
  border: 1px solid #333;
  color: #fff;
  font-family: 'JetBrains Mono', monospace;
  border-radius: 7px;
}
.compact-select {
  padding: 0.45rem 0.7rem;
  font-size: 0.98rem;
}
.compact-input {
  padding: 0.45rem 0.7rem;
  font-size: 0.98rem;
}
.custom-select:focus, .compact-input:focus {
  outline: 2px solid #00ff99;
  border-color: #00ff99;
}
</style>

  <div id="bankForm" class="session-form hidden" style="margin-left: 18rem;">
    <form method="POST" action="{{ url_for('add_bank') }}">
      <div class="form-grid">
        <input type="text" name="bank_name" placeholder="Bank Name" required>
      </div>
      <button type="submit" class="btn">Submit</button>
    </form>
  </div>

  <div class="main-content" style="display: flex; align-items: flex-start; gap: 2.5rem;">
    <!-- Sidebar (explicitly included) -->
    <div style="width: 250px; display: flex; flex-direction: column; gap: 2rem;">
      <!-- Balances Panel -->
      <div class="sidebar" style="background-color: #111; padding: 1rem; border-radius: 10px;">
        <h3 class="sidebar-title">Balances</h3>
        {% set bank_colors = {} %}
        {% for b in banks %}{% set _ = bank_colors.update({b.name: b.color or '#66ccff'}) %}{% endfor %}
        <ul style="list-style: none; padding: 0; margin: 0; color:#aaa; font-size: 0.93em;">
          {% set venture_colors = {'Blackjack': '#00ffff', 'Match Play': '#ffaa00', 'Poker': '#ff66cc'} %}
          <li style="padding: 0.2rem 0 0.2rem 0; color: #fff; font-weight: bold; letter-spacing: 0.5px; text-decoration: underline;">Ventures</li>
          {% for venture in unique_types %}
            <li style="padding: 0.28rem 0; display: flex; justify-content: space-between; align-items: center;{% if loop.last %} margin-bottom: 1.1em;{% endif %}">
              <strong style="color: {{ venture_colors.get(venture, '#00ff99') }};">{{ venture }}</strong>
              {% set vbal = bankroll_totals[venture] %}
              <span style="color: {{ vbal >= 0 and '#00ff99' or '#ff4444' }}; font-weight: bold; min-width: 80px; text-align: right;">${{ '%.2f'|format(vbal) }}</span>
            </li>
          {% endfor %}
          <li style="padding: 0.2rem 0 0.2rem 0; color: #fff; font-weight: bold; letter-spacing: 0.5px; text-decoration: underline;">Banks</li>
          {% for bank, value in bank_balances.items() %}
            <li style="padding: 0.28rem 0; display: flex; flex-direction: column;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong style="color: {{ bank_colors[bank] }};">{{ bank }}</strong>
                <span style="color: {{ value >= 0 and '#00ff99' or '#ff4444' }}; font-weight: bold; min-width: 80px; text-align: right;">${{ '%.2f'|format(value) }}</span>
              </div>
              <ul style="list-style: none; padding-left: 1.5em; margin: 0.1em 0 0 0; font-size: 0.92em;">
                {% for venture in unique_types %}
                  {% set vbal = bank_venture_balances[bank][venture] %}
                  <li style="display: flex; justify-content: space-between; align-items: center; opacity: {{ 1 if vbal != 0 else 0.5 }};">
                    <span style="color: {{ venture_colors.get(venture, '#00ff99') }};">{{ venture }}</span>
                    <span style="color: {{ vbal >= 0 and '#00ff99' or '#ff4444' }}; font-weight: bold; min-width: 60px; text-align: right;">${{ '%.2f'|format(vbal) }}</span>
                  </li>
                {% endfor %}
              </ul>
            </li>
          {% endfor %}
        </ul>
      </div>
      <!-- Ledger Panel -->
      <div class="sidebar" style="background-color: #111; padding: 1rem; border-radius: 10px; max-height: 340px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #444 #111;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 class="sidebar-title">Ledger</h3>
          <button type="button" class="btn" id="openLedgerEditModalBtn" style="padding: 2px 8px; font-size: 0.8rem;">Edit</button>
        </div>
        <ul style="list-style: none; padding: 0; margin: 0;">
          {% for entry in ledger %}
            {% set bank_color = bank_colors.get(entry.account, '#66ccff') %}
            {% set venture_color = venture_colors.get(entry.venture, '#00ff99') %}
            <li class="ledger-display" id="display-{{ entry.id }}" style="padding: 0.25rem 0; color: #aaa; border-bottom: 1px solid #222; font-size: 0.75rem;">
              <div style="display: flex; justify-content: space-between; font-family: 'JetBrains Mono', monospace;">
                <span style="flex: 1; color: {{ bank_color }};">{{ entry.account }}</span>
                <span class="arrow {% if entry.withdrawal > 0 %}negative{% else %}positive{% endif %}">
                  {% if entry.withdrawal > 0 %}→{% else %}←{% endif %}
                </span>
                <span style="flex: 1; text-align: right; color: {{ venture_color }};">{{ entry.venture }}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>{{ entry.date }}</span>
                <span>${{ ((entry.withdrawal or 0) - (entry.deposit or 0)) | abs | round(2) }}</span>
              </div>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    <!-- Dashboard-style grid for charts -->
    <div class="dashboard-grid" style="flex: 1; row-gap: 2.8em;">
      <!-- Top Row -->
      <div class="chart chart-wide">
        <div class="chart-label" style="color: #00ff99; border-color: #00ff99;">Total Bankroll by Date</div>
        <canvas id="totalBankrollChart"></canvas>
        <div style="display: flex; gap: 2.5rem; justify-content: center; margin-top: 0.5em; font-size: 0.93em; margin-bottom: 2.2em;">
          <span style="display: flex; align-items: center; gap: 0.5em;"><span style="width: 18px; height: 3px; background: #00ff99; display: inline-block; border-radius: 2px;"></span>Bankroll (with Vault)</span>
          <span style="display: flex; align-items: center; gap: 0.5em;"><span style="width: 18px; height: 3px; background: #888; display: inline-block; border-radius: 2px;"></span>Cash on Hand</span>
        </div>
      </div>
      <div class="chart chart-wide">
        <div class="chart-label" style="color: {{ vault_color }}; border-color: {{ vault_color }};">Vault Balance by Date</div>
        <canvas id="vaultBankChart"></canvas>
        <div id="vault-legend" style="display: flex; gap: 2rem; justify-content: center; margin-top: 0.5em; font-size: 0.93em; margin-bottom: 2.2em;">
          {% for v, color in venture_colors.items() %}
            <span style="display: flex; align-items: center; gap: 0.5em;"><span style="width: 18px; height: 3px; background: {{ color }}; display: inline-block; border-radius: 2px;"></span>{{ v }}</span>
          {% endfor %}
        </div>
      </div>
      <!-- Bottom Row: Venture Charts -->
      <div class="chart chart-narrow">
        <div class="chart-label" style="color: #00ffff; border-color: #00ffff;">Blackjack Bankroll</div>
        <canvas id="ventureChart-Blackjack"></canvas>
        <div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 0.3em; font-size: 0.91em;">
          <span style="display: flex; align-items: center; gap: 0.5em;"><span style="width: 14px; height: 3px; background: #00ffff; display: inline-block; border-radius: 2px;"></span>Bankroll</span>
          <span style="display: flex; align-items: center; gap: 0.5em;"><span style="width: 14px; height: 3px; background: #888; display: inline-block; border-radius: 2px;"></span>Cash on Hand</span>
        </div>
      </div>
      <div class="chart chart-narrow">
        <div class="chart-label" style="color: #ffaa00; border-color: #ffaa00;">Match Play Bankroll</div>
        <canvas id="ventureChart-Match Play"></canvas>
        <div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 0.3em; font-size: 0.91em;">
          <span style="display: flex; align-items: center; gap: 0.5em;"><span style="width: 14px; height: 3px; background: #ffaa00; display: inline-block; border-radius: 2px;"></span>Bankroll</span>
          <span style="display: flex; align-items: center; gap: 0.5em;"><span style="width: 14px; height: 3px; background: #888; display: inline-block; border-radius: 2px;"></span>Cash on Hand</span>
        </div>
      </div>
      <div class="chart chart-narrow">
        <div class="chart-label" style="color: #ff66cc; border-color: #ff66cc;">Poker Bankroll</div>
        <canvas id="ventureChart-Poker"></canvas>
        <div style="display: flex; gap: 1.5rem; justify-content: center; margin-top: 0.3em; font-size: 0.91em;">
          <span style="display: flex; align-items: center; gap: 0.5em;"><span style="width: 14px; height: 3px; background: #ff66cc; display: inline-block; border-radius: 2px;"></span>Bankroll</span>
          <span style="display: flex; align-items: center; gap: 0.5em;"><span style="width: 14px; height: 3px; background: #888; display: inline-block; border-radius: 2px;"></span>Cash on Hand</span>
        </div>
      </div>
    </div>
  </div>

<!-- Ledger Edit Modal -->
<div id="ledgerEditModal" class="modal-overlay">
  <div class="modal-content" style="max-width: 800px;">
    <h2>Edit Ledger Entries</h2>
    <form id="ledgerBulkEditForm" method="POST" action="{{ url_for('update_ledger_bulk') }}">
      <div class="table-wrapper">
        <table class="table">
          <thead>
            <tr>
              <th style="width: 40px;"></th>
              <th style="width: 100px;">Date</th>
              <th style="width: 160px;">Account</th>
              <th style="width: 120px;">Venture</th>
              <th style="width: 130px;">Amount</th>
              <th style="width: 130px;">Type</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in ledger %}
            <tr data-ledger-id="{{ entry.id }}">
              <td class="trash-cell">
                <button type="button" class="btn btn-outline-red trash-btn" title="Delete this row">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6l-2 14H7L5 6"></path>
                    <path d="M10 6V4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2"></path>
                  </svg>
                </button>
              </td>
              <input type="hidden" name="id_{{ entry.id }}" value="{{ entry.id }}">
              <td><input type="date" name="date_{{ entry.id }}" value="{{ entry.date.strftime('%Y-%m-%d') if entry.date else '' }}" class="modal-input"></td>
              <td>
                <select name="account_{{ entry.id }}" class="modal-input styled-select" style="min-width: 150px;">
                  {% for bank in banks %}
                    <option value="{{ bank.name }}" {% if entry.account == bank.name %}selected{% endif %}>{{ bank.name }}</option>
                  {% endfor %}
                </select>
              </td>
              <td>
                <select name="venture_{{ entry.id }}" class="modal-input styled-select">
                  {% for venture in unique_types %}
                    <option value="{{ venture }}" {% if entry.venture == venture %}selected{% endif %}>{{ venture }}</option>
                  {% endfor %}
                </select>
              </td>
              <td><input type="number" step="0.01" name="amount_{{ entry.id }}" value="{{ '%.2f'|format(entry.deposit if entry.deposit > 0 else entry.withdrawal) }}" class="modal-input"></td>
              <td>
                <select name="type_{{ entry.id }}" class="modal-input styled-select" style="min-width: 120px;">
                  <option value="deposit" {% if entry.deposit > 0 %}selected{% endif %}>Deposit</option>
                  <option value="withdrawal" {% if entry.withdrawal > 0 %}selected{% endif %}>Withdrawal</option>
                </select>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelLedgerEditBtn" class="btn btn-outline-red">Cancel</button>
        <button type="submit" class="btn btn-outline-green">Save</button>
      </div>
    </form>
  </div>
</div>










<!-- Scripts -->
<!-- Chart.js scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
  Chart.defaults.responsive = true;
  Chart.defaults.maintainAspectRatio = false;
  Chart.defaults.devicePixelRatio = window.devicePixelRatio || 1;

  // Helper to create area chart with two lines and legend
  function createDualAreaChart(ctx, label1, data1, color1, label2, data2, color2) {
    return new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [
          {
            label: label1,
            data: data1,
            borderColor: color1,
            backgroundColor: color1 + '33',
            tension: 0.3,
            fill: true,
            pointRadius: 3
          },
          {
            label: label2,
            data: data2,
            borderColor: color2,
            backgroundColor: color2 + '00',
            tension: 0.3,
            fill: false,
            pointRadius: 3,
            borderDash: [5, 5]
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: context => `$${context.parsed.y.toLocaleString()}`
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'day' },
            ticks: {
              color: '#ffffff',
              font: { family: "'JetBrains Mono', monospace", size: 11 }
            },
            grid: { color: '#333' }
          },
          y: {
            ticks: {
              color: '#ffffff',
              font: { family: "'JetBrains Mono', monospace", size: 11 },
              callback: value => `$${value.toLocaleString()}`
            },
            grid: { color: '#333' }
          }
        }
      }
    });
  }

  // Helper for single-line area chart
  function createAreaChart(ctx, label, data, color) {
    return new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          label: label,
          data: data,
          borderColor: color,
          backgroundColor: color + '33',
          tension: 0.3,
          fill: true,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: context => `$${context.parsed.y.toLocaleString()}`
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'day' },
            ticks: {
              color: '#ffffff',
              font: { family: "'JetBrains Mono', monospace", size: 11 }
            },
            grid: { color: '#333' }
          },
          y: {
            ticks: {
              color: '#ffffff',
              font: { family: "'JetBrains Mono', monospace", size: 11 },
              callback: value => `$${value.toLocaleString()}`
            },
            grid: { color: '#333' }
          }
        }
      }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Top charts
    createDualAreaChart(
      document.getElementById('totalBankrollChart').getContext('2d'),
      'Bankroll (with Vault)',
      {{ total_bankroll_with_vault|tojson }},
      '#00ff99',
      'Cash on Hand',
      {{ total_cash_on_hand|tojson }},
      '#888'
    );
    // Vault chart: multi-line for each venture, plus original filled area
    const vaultCtx = document.getElementById('vaultBankChart').getContext('2d');
    const vaultData = [];
    const vaultColors = {{ venture_colors|tojson }};
    const vaultByVenture = {{ vault_bank_chart_by_venture|tojson }};
    // Add the original total vault line as a filled area
    vaultData.push({
      label: 'Total Vault',
      data: {{ vault_bank_chart|tojson }},
      borderColor: '{{ vault_color }}',
      backgroundColor: ('{{ vault_color }}' || '#66ccff') + '33',
      tension: 0.3,
      fill: true,
      pointRadius: 3
    });
    // Add per-venture lines (not filled)
    for (const [venture, data] of Object.entries(vaultByVenture)) {
      vaultData.push({
        label: venture,
        data: data,
        borderColor: vaultColors[venture] || '#66ccff',
        backgroundColor: (vaultColors[venture] || '#66ccff') + '00',
        tension: 0.3,
        fill: false,
        pointRadius: 3
      });
    }
    new Chart(vaultCtx, {
      type: 'line',
      data: { datasets: vaultData },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: context => `${context.dataset.label}: $${context.parsed.y.toLocaleString()}`
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'day' },
            ticks: {
              color: '#ffffff',
              font: { family: "'JetBrains Mono', monospace", size: 11 }
            },
            grid: { color: '#333' }
          },
          y: {
            ticks: {
              color: '#ffffff',
              font: { family: "'JetBrains Mono', monospace", size: 11 },
              callback: value => `$${value.toLocaleString()}`
            },
            grid: { color: '#333' }
          }
        }
      }
    });
    // Bottom row: Blackjack, Match Play, Poker
    const ventureColors = { 'Blackjack': '#00ffff', 'Match Play': '#ffaa00', 'Poker': '#ff66cc' };
    {% for chart in venture_charts %}
      createDualAreaChart(
        document.getElementById('ventureChart-{{ chart.name }}').getContext('2d'),
        'Bankroll',
        {{ chart.data|tojson }},
        ventureColors['{{ chart.name }}'] || '#00ff99',
        'Cash on Hand',
        {{ chart.cash_on_hand|tojson }},
        '#888'
      );
    {% endfor %}
  });
</script>

<!-- Only one <script> block for modal logic should remain at the end of the file. -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ledgerEditModal = document.getElementById('ledgerEditModal');
    const openLedgerEditModalBtn = document.getElementById('openLedgerEditModalBtn');
    const cancelLedgerEditBtn = document.getElementById('cancelLedgerEditBtn');

    if (openLedgerEditModalBtn) {
      openLedgerEditModalBtn.addEventListener('click', function() {
        ledgerEditModal.style.display = 'flex';
      });
    }
    if (cancelLedgerEditBtn) {
      cancelLedgerEditBtn.addEventListener('click', function() {
        ledgerEditModal.style.display = 'none';
      });
    }
    if (ledgerEditModal) {
      ledgerEditModal.addEventListener('click', function(e) {
        if (e.target === ledgerEditModal) ledgerEditModal.style.display = 'none';
      });
    }

    // Trash button logic for ledger modal
    document.querySelectorAll('#ledgerEditModal .trash-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const row = btn.closest('tr');
        const ledgerId = row.getAttribute('data-ledger-id');
        fetch(`/delete_ledger/${ledgerId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        }).then(response => {
          if (response.ok) {
            row.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            row.style.opacity = '0';
            row.style.transform = 'translateX(-20px)';
            setTimeout(() => row.remove(), 300);
          } else {
            alert('Error deleting ledger entry');
          }
        });
      });
    });
  });
</script>

<!-- Manage Banks Modal (styled like Manage Ventures, compact) -->
<div id="bankModal" class="modal-overlay" style="display: none;">
  <div class="modal-content" style="max-width: 500px; width: 90%;">
    <!-- Modal header with inline Edit button -->
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
      <h3 style="color: #fff; text-align: left; font-size: 1.15rem; font-family: 'JetBrains Mono', monospace; font-weight: bold; margin: 0;">Manage Banks</h3>
      <button id="editBanksModeBtn" class="btn btn-outline" style="font-size: 0.92em; padding: 0.2rem 0.8rem; border: 1px solid #444; color: #fff; margin-left: 1.2rem;">Edit</button>
    </div>
    <div id="bank-management-list" style="max-height: 180px; overflow-y: auto; margin-bottom: 1.2rem;">
      {% for bank in banks %}
        <div class="venture-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.45rem 0.75rem; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; margin-bottom: 0.5rem; position: relative;">
          <div class="venture-info" style="display: flex; align-items: center; gap: 0.5rem;">
            <div class="venture-color bank-color-dot" data-bank-id="{{ bank.id }}" style="width: 11px; height: 11px; border-radius: 50%; background: {{ bank.color or '#66ccff' }}; cursor: pointer; border: 2px solid #222;"></div>
            <span class="venture-name" style="color: #fff; font-weight: 600; font-size: 0.98rem;">{{ bank.name }}</span>
            {% if bank.is_vault and banks|length > 1 %}<span class="badge" style="background:#222; color:#00ffff; border-radius:4px; font-size:0.8em; padding:2px 7px; margin-left:6px;">Vault</span>{% endif %}
          </div>
          <div style="display: flex; align-items: center; gap: 0.7rem;">
            <button class="set-vault-btn btn btn-outline-green" data-bank-id="{{ bank.id }}" style="font-size: 0.82rem; padding: 0.12rem 0.5rem; margin-right: 0.3rem; border-radius: 4px; line-height: 1.1; display: none;">Set as Vault</button>
            <button class="delete-venture-btn delete-bank-btn" data-bank-id="{{ bank.id }}" style="background: #ff4444; color: white; border: none; padding: 0.12rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.82rem; font-family: 'JetBrains Mono', monospace; font-weight: bold; transition: background 0.2s; line-height: 1.1; display: none;">Delete</button>
          </div>
        </div>
      {% endfor %}
      {% if banks|length == 0 %}
        <div class="no-ventures" style="color: #666; font-style: italic; text-align: center; padding: 0.7rem; font-size: 0.95rem;">No banks added yet</div>
      {% endif %}
    </div>
    <form id="addBankForm" style="display: flex; gap: 0.4rem; justify-content: flex-end; margin-bottom: 1rem;">
      <input type="text" id="newBankName" class="styled-input" placeholder="Bank Name" required style="flex: 1; font-size: 0.98rem; padding: 0.35rem 0.7rem;">
      <button type="submit" class="btn btn-outline-green" style="font-size: 0.98rem; padding: 0.35rem 1.1rem;">Add</button>
    </form>
    <div style="color: #666; font-size: 0.93rem; margin-bottom: 1rem;">Remove banks you no longer need. This won't delete your ledger data.</div>
    <!-- Modal footer -->
    <div style="display: flex; justify-content: flex-end; gap: 1.2rem; margin-top: 1.5rem;">
      <button id="saveBankModalBtn" class="btn btn-outline-green">Save</button>
    </div>
  </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', function() {
  // Bank Modal logic
  const bankModal = document.getElementById('bankModal');
  const openBankModalBtn = document.getElementById('openBankModalBtn');
  const closeBankModalBtn = document.getElementById('closeBankModalBtn');
  let originalVaultId = null;
  if (openBankModalBtn) {
    openBankModalBtn.addEventListener('click', function() {
      // Set originalVaultId when opening the modal
      const badge = document.querySelector('.venture-info .badge');
      if (badge) {
        const btn = badge.closest('.venture-item').querySelector('.set-vault-btn');
        originalVaultId = btn ? btn.getAttribute('data-bank-id') : null;
      } else {
        originalVaultId = null;
      }
      bankModal.style.display = 'flex';
    });
  }
  if (closeBankModalBtn) {
    closeBankModalBtn.addEventListener('click', function() {
      bankModal.style.display = 'none';
    });
  }
  if (bankModal) {
    bankModal.addEventListener('click', function(e) {
      if (e.target === bankModal) bankModal.style.display = 'none';
    });
  }
  // Add bank
  const addBankForm = document.getElementById('addBankForm');
  if (addBankForm) {
    addBankForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const name = document.getElementById('newBankName').value.trim();
      if (!name) return;
      const formData = new FormData();
      formData.append('bank_name', name);
      const resp = await fetch('{{ url_for('add_bank') }}', { method: 'POST', body: formData });
      document.getElementById('newBankName').value = '';
      // Add the new bank to the list live
      if (resp.ok) {
        // Remove empty message if present
        const empty = document.querySelector('.no-ventures');
        if (empty) empty.remove();
        // Create new bank item
        const list = document.getElementById('bank-management-list');
        const div = document.createElement('div');
        div.className = 'venture-item';
        div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.45rem 0.75rem; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; margin-bottom: 0.5rem; position: relative;';
        div.innerHTML = `<div class='venture-info' style='display: flex; align-items: center; gap: 0.5rem;'><div class='venture-color' style='width: 11px; height: 11px; border-radius: 50%; background: #66ccff;'></div><span class='venture-name' style='color: #fff; font-weight: 600; font-size: 0.98rem;'>${name}</span></div><div style='display: flex; align-items: center; gap: 0.7rem;'><button class='set-vault-btn btn btn-outline-green' data-bank-id='${div.dataset.bankId}' style='font-size: 0.82rem; padding: 0.12rem 0.5rem; margin-right: 0.3rem; border-radius: 4px; line-height: 1.1; display: none;'>Set as Vault</button><button class='delete-venture-btn delete-bank-btn' style='background: #ff4444; color: white; border: none; padding: 0.12rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.82rem; font-family: JetBrains Mono, monospace; font-weight: bold; transition: background 0.2s; line-height: 1.1; display: none;' data-bank-id='${div.dataset.bankId}'>Delete</button></div>`;
        list.appendChild(div);
        // Fetch the new bank's ID by reloading the list (or you can do a smarter fetch if needed)
        // For now, just re-attach delete logic to all delete buttons
        document.querySelectorAll('.delete-bank-btn').forEach(btn => {
          btn.onclick = async function() {
            const bankId = btn.getAttribute('data-bank-id');
            await fetch(`/delete_bank/${bankId}`, { method: 'POST' });
            const item = btn.closest('.venture-item');
            if (item) item.remove();
            if (document.querySelectorAll('.venture-item').length === 0) {
              const list = document.getElementById('bank-management-list');
              if (list && !document.querySelector('.no-ventures')) {
                const empty = document.createElement('div');
                empty.className = 'no-ventures';
                empty.style.cssText = 'color: #666; font-style: italic; text-align: center; padding: 0.7rem; font-size: 0.95rem;';
                empty.textContent = 'No banks added yet';
                list.appendChild(empty);
              }
            }
          };
        });
      }
    });
  }
  // Delete bank
  document.querySelectorAll('.delete-bank-btn').forEach(btn => {
    btn.onclick = async function() {
      const bankId = btn.getAttribute('data-bank-id');
      // No confirmation dialog
      await fetch(`/delete_bank/${bankId}`, { method: 'POST' });
      // Remove the bank item from the DOM
      const item = btn.closest('.venture-item');
      if (item) item.remove();
      // If no banks left, show empty message
      if (document.querySelectorAll('.venture-item').length === 0) {
        const list = document.getElementById('bank-management-list');
        if (list && !document.querySelector('.no-ventures')) {
          const empty = document.createElement('div');
          empty.className = 'no-ventures';
          empty.style.cssText = 'color: #666; font-style: italic; text-align: center; padding: 0.7rem; font-size: 0.95rem;';
          empty.textContent = 'No banks added yet';
          list.appendChild(empty);
        }
      }
    };
  });
  // Color picker logic for banks (custom popover)
  let openColorPopover = null;
  document.querySelectorAll('.bank-color-dot').forEach(dot => {
    dot.addEventListener('click', function(e) {
      e.stopPropagation();
      // Close any open popover
      if (openColorPopover) openColorPopover.remove();
      // Create popover
      const popover = document.createElement('div');
      popover.style.position = 'absolute';
      popover.style.zIndex = 10000;
      popover.style.background = '#222';
      popover.style.border = '1px solid #444';
      popover.style.borderRadius = '8px';
      popover.style.padding = '0.7rem 1rem 0.7rem 1rem';
      popover.style.boxShadow = '0 2px 12px #000a';
      popover.style.display = 'flex';
      popover.style.flexDirection = 'column';
      popover.style.alignItems = 'center';
      popover.style.gap = '0.7rem';
      // Color input
      const input = document.createElement('input');
      input.type = 'color';
      input.value = rgb2hex(getComputedStyle(dot).backgroundColor) || '#66ccff';
      input.style.width = '2.2rem';
      input.style.height = '2.2rem';
      input.style.border = 'none';
      input.style.background = 'none';
      input.style.cursor = 'pointer';
      // Save button
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Save';
      saveBtn.className = 'btn btn-outline-green';
      saveBtn.style.marginTop = '0.2rem';
      saveBtn.style.fontSize = '0.95rem';
      // Cancel button
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancel';
      cancelBtn.className = 'btn';
      cancelBtn.style.marginTop = '0.2rem';
      cancelBtn.style.fontSize = '0.95rem';
      // Layout
      popover.appendChild(input);
      const btnRow = document.createElement('div');
      btnRow.style.display = 'flex';
      btnRow.style.gap = '0.7rem';
      btnRow.appendChild(cancelBtn);
      btnRow.appendChild(saveBtn);
      popover.appendChild(btnRow);
      // Position popover below dot
      document.body.appendChild(popover);
      const rect = dot.getBoundingClientRect();
      popover.style.left = (window.scrollX + rect.left - popover.offsetWidth/2 + dot.offsetWidth/2) + 'px';
      popover.style.top = (window.scrollY + rect.bottom + 8) + 'px';
      openColorPopover = popover;
      // Save logic
      saveBtn.onclick = function() {
        const color = input.value;
        const bankId = dot.getAttribute('data-bank-id');
        fetch(`/api/update_bank_color/${bankId}`, {
          method: 'POST',
          body: new URLSearchParams({ color }),
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        }).then(resp => resp.json()).then(data => {
          if (data.success) {
            dot.style.background = color;
          }
          popover.remove();
          openColorPopover = null;
        });
      };
      // Cancel logic
      cancelBtn.onclick = function() {
        popover.remove();
        openColorPopover = null;
      };
      // Close on outside click
      setTimeout(() => {
        document.addEventListener('mousedown', outsideClick, { once: true });
      }, 0);
      function outsideClick(ev) {
        if (!popover.contains(ev.target)) {
          popover.remove();
          openColorPopover = null;
        }
      }
    });
  });
  // Set as Vault button logic
  document.querySelectorAll('.set-vault-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const bankId = btn.getAttribute('data-bank-id');
      fetch(`/api/update_bank_attributes/${bankId}`, {
        method: 'POST',
        body: new URLSearchParams({ is_vault: true }),
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      }).then(resp => resp.json()).then(data => {
        if (data.success) {
          // Remove all Vault badges
          document.querySelectorAll('.venture-info .badge').forEach(b => {
            if (b.textContent.trim() === 'Vault') b.remove();
          });
          // Hide all Set as Vault buttons
          document.querySelectorAll('.set-vault-btn').forEach(b => b.style.display = '');
          // Add badge to this item
          const item = btn.closest('.venture-item');
          const info = item.querySelector('.venture-info');
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.style.cssText = 'background:#222; color:#00ffff; border-radius:4px; font-size:0.8em; padding:2px 7px; margin-left:6px;';
          badge.textContent = 'Vault';
          info.appendChild(badge);
          // Hide this button
          btn.style.display = 'none';
        }
      });
    });
  });
  // If only one bank, disable and uncheck Vault radio
  // This logic is no longer needed as there's no radio input for vault selection.
  // The Set as Vault button handles the vault selection.
  // if (document.querySelectorAll('.vault-radio').length === 1) {
  //   const radio = document.querySelector('.vault-radio');
  //   radio.checked = false;
  //   radio.disabled = true;
  // }
  // Set Vault mode button logic
  const setVaultModeBtn = document.getElementById('setVaultModeBtn');
  if (setVaultModeBtn) {
    setVaultModeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      // Highlight all Set as Vault buttons
      document.querySelectorAll('.set-vault-btn').forEach(btn => {
        btn.style.boxShadow = '0 0 0 2px #00ffff, 0 0 8px #00ffff55';
        btn.style.opacity = '1';
      });
      // Remove highlight after a selection or after 5 seconds
      const clearHighlight = () => {
        document.querySelectorAll('.set-vault-btn').forEach(btn => {
          btn.style.boxShadow = '';
          btn.style.opacity = '';
        });
      };
      document.querySelectorAll('.set-vault-btn').forEach(btn => {
        btn.addEventListener('click', clearHighlight, { once: true });
      });
      setTimeout(clearHighlight, 5000);
    });
  }
  // Edit mode logic
  const editBanksModeBtn = document.getElementById('editBanksModeBtn');
  const saveBankModalBtn = document.getElementById('saveBankModalBtn');
  const cancelBankModalBtn = document.getElementById('cancelBankModalBtn');
  let editMode = false;
  let intendedVaultId = null;
  let banksToDelete = new Set();
  // Store original state for cancel
  function enterEditMode() {
    editMode = true;
    document.querySelectorAll('.set-vault-btn, .delete-bank-btn').forEach(btn => btn.style.display = '');
    editBanksModeBtn.textContent = 'Done';
    // Store original vault
    const currentVault = document.querySelector('.set-vault-btn[style*="display: none"]')?.closest('.venture-item')?.querySelector('.badge');
    originalVaultId = null;
    document.querySelectorAll('.venture-item').forEach(item => {
      if (item.querySelector('.badge') && item.querySelector('.badge').textContent.trim() === 'Vault') {
        originalVaultId = item.querySelector('.set-vault-btn')?.getAttribute('data-bank-id');
      }
    });
    intendedVaultId = originalVaultId;
    banksToDelete.clear();
  }
  function exitEditMode() {
    editMode = false;
    document.querySelectorAll('.set-vault-btn, .delete-bank-btn').forEach(btn => btn.style.display = 'none');
    editBanksModeBtn.textContent = 'Edit';
    // Do NOT revert the badge to the original vault here. Just leave the badge on the intendedVaultId.
    // Unmark any banks visually for deletion
    document.querySelectorAll('.venture-item').forEach(item => {
      item.style.opacity = '';
    });
  }
  if (editBanksModeBtn) {
    editBanksModeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      if (!editMode) {
        enterEditMode();
      } else {
        exitEditMode();
      }
    });
  }
  // Set as Vault button logic (edit mode only)
  document.querySelectorAll('.set-vault-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      if (!editMode) return;
      // Remove all Vault badges and show all Set as Vault buttons
      document.querySelectorAll('.venture-info .badge').forEach(b => { if (b.textContent.trim() === 'Vault') b.remove(); });
      document.querySelectorAll('.set-vault-btn').forEach(b => b.style.display = '');
      // Add badge to this item and hide its Set as Vault button
      const item = btn.closest('.venture-item');
      const info = item.querySelector('.venture-info');
      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.style.cssText = 'background:#222; color:#00ffff; border-radius:4px; font-size:0.8em; padding:2px 7px; margin-left:6px;';
      badge.textContent = 'Vault';
      info.appendChild(badge);
      btn.style.display = 'none';
      intendedVaultId = btn.getAttribute('data-bank-id');
    });
  });
  // Delete button logic (edit mode only)
  document.querySelectorAll('.delete-bank-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      if (!editMode) return;
      const item = btn.closest('.venture-item');
      const bankId = btn.getAttribute('data-bank-id');
      if (banksToDelete.has(bankId)) {
        banksToDelete.delete(bankId);
        item.style.opacity = '';
      } else {
        banksToDelete.add(bankId);
        item.style.opacity = '0.4';
      }
    });
  });
  // Save button logic
  saveBankModalBtn.addEventListener('click', function(e) {
    e.preventDefault();
    // Save vault change
    if (intendedVaultId && intendedVaultId !== originalVaultId) {
      fetch(`/api/update_bank_attributes/${intendedVaultId}`, {
        method: 'POST',
        body: new URLSearchParams({ is_vault: true }),
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      }).then(resp => resp.json()).then(data => {
        // Optionally handle response
      });
    }
    // Save deletions
    banksToDelete.forEach(bankId => {
      fetch(`/delete_bank/${bankId}`, {
        method: 'POST'
      }).then(resp => {
        // Optionally handle response
      });
    });
    // After saving, reload the page or update the UI as needed
    location.reload();
  });
  // Cancel button logic
  cancelBankModalBtn.addEventListener('click', function(e) {
    e.preventDefault();
    bankModal.style.display = 'none';
    location.reload();
  });
  // Helper to convert rgb to hex
  function rgb2hex(rgb) {
    if (!rgb) return '#66ccff';
    const result = rgb.match(/\d+/g);
    if (!result) return '#66ccff';
    return '#' + result.slice(0, 3).map(x => (+x).toString(16).padStart(2, '0')).join('');
    }
  });
</script>

<script>
function openModal(id) {
  document.getElementById(id).style.display = 'flex';
}
function closeModal(id) {
  document.getElementById(id).style.display = 'none';
}
document.getElementById('openDepositModalBtn').onclick = function() {
  openModal('depositModal');
  populateVentureDropdown('depositVentureSelect');
};
document.getElementById('openWithdrawalModalBtn').onclick = function() {
  openModal('withdrawalModal');
  populateVentureDropdown('withdrawalVentureSelect');
};
document.getElementById('depositModal').onclick = function(e) {
  if (e.target === this) closeModal('depositModal');
};
document.getElementById('withdrawalModal').onclick = function(e) {
  if (e.target === this) closeModal('withdrawalModal');
};
function populateVentureDropdown(selectId) {
  // Get unique_types from template context
  const uniqueTypes = {{ unique_types|tojson }};
  // Fetch user ventures from API and merge
  fetch('/api/user_ventures').then(r => r.json()).then(userVentures => {
    const allVentures = Array.from(new Set([...uniqueTypes, ...userVentures])).sort();
    const select = document.getElementById(selectId);
    select.innerHTML = '';
    allVentures.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      select.appendChild(opt);
    });
  });
}
</script>


{% endblock %}