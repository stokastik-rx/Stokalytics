{% extends 'base.html' %}

{% block body_class %}dashboard-page{% endblock %}

{% block content %}
<div class="container">
  <h1>Poker</h1>
  <div class="button-row" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 1.5rem;">
    <button class="btn btn-outline-green" onclick="toggleSessionForm()">New Session</button>
    <a href="{{ url_for('view_logs') }}" class="btn">View Logs</a>
    <a href="{{ url_for('view_banking') }}" class="btn">Banking</a>
    <a href="{{ url_for('view_comps') }}" class="btn">Comps</a>
    <a href="{{ url_for('view_locations') }}" class="btn">Locations</a>
    <a href="{{ url_for('view_logs') }}?type=Poker" class="btn">Poker Logs</a>
    <a href="{{ url_for('donate') }}" class="btn" style="margin-right: 0;">Support Development</a>
    <button class="btn" onclick="openFeedbackModal()">Give Feedback</button>
    <a href="#" class="btn">Settings</a>
    <a href="{{ url_for('logout')}}" class="btn btn-outline-red">Logout</a>
  </div>

  <!-- Collapsible session form (reuse from dashboard) -->
  <div id="sessionForm" class="session-form hidden" style="margin-left:-0.60rem;">
    <form method="POST" action="/add_session">
      <div class="form-grid">
        <div class="input-lock-container">
          <input type="date" name="date" id="dateInput" required>
        </div>
        <div class="input-lock-container">
          <input type="text" name="location" id="locationInput" placeholder="Location">
          <button type="button" class="lock-btn" data-target="locationInput">ðŸ”’</button>
        </div>
        <div class="input-lock-container">
          <input type="text" name="type" id="typeInput" placeholder="Type">
          <button type="button" class="lock-btn" data-target="typeInput">ðŸ”’</button>
        </div>
        <input type="time" name="time_in" placeholder="Time In">
        <input type="time" name="time_out" placeholder="Time Out">
        <input type="number" name="money_in" placeholder="Money In" step="0.01">
        <input type="number" name="money_out" placeholder="Money Out" step="0.01">
        <div class="input-lock-container">
          <input type="number" name="comps_in" id="compsInInput" placeholder="Comps In" step="0.01">
          <button type="button" class="lock-btn" data-target="compsInInput">ðŸ”’</button>
        </div>
        <div class="input-lock-container">
          <input type="number" name="comps_out" id="compsOutInput" placeholder="Comps Out" step="0.01">
          <button type="button" class="lock-btn" data-target="compsOutInput">ðŸ”’</button>
        </div>
        <input type="number" name="tips" placeholder="Tips" step="0.01">
      </div>
      <button type="submit" class="btn">Submit</button>
    </form>
  </div>

  <div class="main-content" style="display: flex; gap: 2.5rem; align-items: flex-start;">
    <div class="sidebar" style="width: 200px; background-color: #111; padding: 1rem; border-radius: 10px; max-height: 90vh; flex-shrink: 0;">
      <h3 style="color: #ffffff; font-family: Consolas, monospace; font-size: 0.85rem;">Venture Statistics</h3>
      <ul style="list-style: none; padding-left: 0; color: #ccc; font-family: 'JetBrains Mono', monospace; font-size: 0.82em;">
        <li style="margin-bottom: 0.3em;">Total Profit/Loss: <span style="color:{% if poker_stats.total_profit >= 0 %}#00ff99{% else %}#ff4444{% endif %}; float:right;">${{ '%.2f'|format(poker_stats.total_profit) }}</span></li>
        <li style="margin-bottom: 0.3em;">Total Sessions: <span style="color:#00ccff; float:right;">{{ poker_stats.total_sessions }}</span></li>
        <li style="margin-bottom: 0.3em;">Total Hours: <span style="color:#00ccff; float:right;">{{ '%.2f'|format(poker_stats.total_hours) }}</span></li>
        <li style="margin-bottom: 0.3em;">Hourly Rate: <span style="color:{% if poker_stats.total_hours > 0 and poker_stats.total_profit / poker_stats.total_hours >= 0 %}#00ff99{% else %}#ff4444{% endif %}; float:right;">${{ '%.2f'|format(poker_stats.total_profit / poker_stats.total_hours if poker_stats.total_hours > 0 else 0) }}</span></li>
        <li style="margin-bottom: 0.3em;">Best Session: <span style="color:#00ff99; float:right;">${{ '%.2f'|format(poker_stats.best_session) }}</span></li>
        <li style="margin-bottom: 0.3em;">Worst Session: <span style="color:#ff4444; float:right;">${{ '%.2f'|format(poker_stats.worst_session) }}</span></li>
      </ul>
        <div style="margin-top: 1.2em; display: flex; flex-direction: column; align-items: center; justify-content: center;">
          <div style="color: #ccc; font-size: 0.85em; text-align: center; margin-bottom: 0.5em;">Include Tips in PnL</div>
          <label class="custom-slider-switch">
            <input type="checkbox" id="tips-toggle" {% if tips_included %}checked{% endif %}>
            <span class="custom-slider"></span>
          </label>
        </div>
    </div>
    <div style="flex: 1; min-width: 0;">
      <div style="display: flex; gap: 2rem; margin-bottom: 2rem;">
        <div class="chart chart-wide" style="flex: 1; height: 280px;">
          <div class="chart-label green">Poker P/L</div>
          <canvas id="pokerPLChart"></canvas>
        </div>
        <div class="chart chart-wide" style="flex: 1; height: 280px;">
          <div class="chart-label blue">Poker Bankroll</div>
          <canvas id="pokerBankrollChart"></canvas>
        </div>
      </div>
      <div style="height: 16px;"></div>
      <div class="table-wrapper" style="max-height: 260px; overflow-y: auto; margin-top: 0.5rem; overflow-x: auto;">
        <table class="table" style="min-width: 900px;">
          <thead>
            <tr>
              <th class="date-col" style="position: sticky; top: 0; background: #1a1a1a; z-index: 2; white-space: nowrap; padding-right: 1.5em;">Date</th>
              <th class="change-col" style="position: sticky; top: 0; background: #1a1a1a; z-index: 2; width: auto;">Net Change</th>
              <th style="position: sticky; top: 0; background: #1a1a1a; z-index: 2; min-width: 100px;">Stakes</th>
              <th style="position: sticky; top: 0; background: #1a1a1a; z-index: 2; min-width: 100px;">Softness</th>
              <th style="position: sticky; top: 0; background: #1a1a1a; z-index: 2; min-width: 100px;">Focus</th>
              <th style="position: sticky; top: 0; background: #1a1a1a; z-index: 2; min-width: 90px;">BB/100</th>
              <th style="position: sticky; top: 0; background: #1a1a1a; z-index: 2; min-width: 90px;">Swing Score</th>
            </tr>
          </thead>
          <tbody>
            {% for row in records %}
            <tr data-poker-id="{{ row.id }}" data-stakes="{{ row.stakes }}">
              <td class="date-col" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 1.5em;">{{ row.date.strftime('%m/%d/%Y') }}</td>
              <td class="change-col {{ 'positive' if row.change > 0 else 'negative' if row.change < 0 else '' }}" style="overflow: hidden; text-overflow: ellipsis;">
                <span class="change-amount">${{ "%.2f"|format(row.change) }}</span>
              </td>
              <td><select class="stakes-select styled-select"></select></td>
              <td>
                <select class="softness-select styled-select">
                  <option value=""></option>
                  <option value="1" {% if row.softness == 1 %}selected{% endif %}>1 - Soft</option>
                  <option value="2" {% if row.softness == 2 %}selected{% endif %}>2</option>
                  <option value="3" {% if row.softness == 3 %}selected{% endif %}>3</option>
                  <option value="4" {% if row.softness == 4 %}selected{% endif %}>4</option>
                  <option value="5" {% if row.softness == 5 %}selected{% endif %}>5 - Sweaty</option>
                </select>
              </td>
              <td>
                <select class="focus-select styled-select">
                  <option value=""></option>
                  <option value="1" {% if row.focus == 1 %}selected{% endif %}>1 - Tilted</option>
                  <option value="2" {% if row.focus == 2 %}selected{% endif %}>2</option>
                  <option value="3" {% if row.focus == 3 %}selected{% endif %}>3 - Average</option>
                  <option value="4" {% if row.focus == 4 %}selected{% endif %}>4</option>
                  <option value="5" {% if row.focus == 5 %}selected{% endif %}>5 - Locked In</option>
                </select>
              </td>
              <td class="bb100-cell">--</td>
              <td class="swing-cell">--</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="{{ url_for('static', filename='chart.js') }}"></script>
<script>
  // Chart.js rendering for poker dashboard
  Chart.defaults.responsive = true;
  Chart.defaults.maintainAspectRatio = false;
  Chart.defaults.devicePixelRatio = window.devicePixelRatio || 1;

  const pokerChartData = {{ poker_chart|tojson|safe }};
  const pokerBankrollData = {{ poker_bankroll|tojson|safe }};
  
  // Tips toggle functionality
  document.getElementById('tips-toggle').addEventListener('change', function() {
    const tipsIncluded = this.checked ? '1' : '0';
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('tips_included', tipsIncluded);
    window.location.href = currentUrl.toString();
  });
  
  // Render charts (similar to blackjack but for poker data)
  // ... (chart rendering logic)
</script>
{% endblock %} 